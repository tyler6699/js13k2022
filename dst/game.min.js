var n,o=[];function l(t,e){for(m=n.createBuffer(1,96e3,48e3),gainNode=n.createGain(),b=m.getChannelData(0),i=96e3;i--;)b[i]=getSound(t,i);s=n.createBufferSource(),s.buffer=m,s.connect(gainNode),gainNode.connect(n.destination),gainNode.gain.value=e,s.start()}function a(e){if(t=((t,e)=>(e-t)/e),e>7e4)return null;t(e,7e4);return Math.sin(.001*e*Math.sin(.009*e)+Math.sin(e/100))}function u(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return(128&Math.pow(t,1.055)?1:-1)*Math.pow(e,2)}function d(t){if(t>5e4)return null;var e=(5e4-t)/5e4;return(200&Math.pow(t,.9)?1:-1)*Math.pow(e,3)}function g(t){var e=1e4;if(t>e)return null;var i=(e-t)/e,s=Math.pow(i,2.1);return Math.pow(t,3)&(t<3333.3333333333335?16:99)?s:-s}function v(t){if(t>2e4)return null;var e=(2e4-t)/2e4;return Math.sin(.003*-t*Math.sin(.09*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function p(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return Math.sin(.01*t*Math.sin(.009*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function k(e){if(e>2e3)return null;t=((t,e)=>(e-t)/e);var i=t(e,2e3);return 33&Math.pow(50*e,.7)?i:-i}function M(e){if(t=((t,e)=>(e-t)/e),e>2e4)return null;var i=t(e,2e4);return e*=.04,Math.sin(.03*-e*Math.sin(.09*e+Math.sin(e/200))+Math.sin(e/100))*i}function A(){var t=0;t=q/Q>4/3?(q=Q*(4/3))/1216:(Q=q/(4/3))/832,this.scale=3*t,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new V(16,16,q/2,200,0,T.HERO,this.scale),this.introT=0,this.shake=0,this.shakeTime=0,this.reset=!1,this.wait=2,this.genLevel=function(t){for(this.bkcol=I(),this.levels=[],i=0;i<1;i++){var e=new J(t,q,Q,i,this.scale);e.reset(i,this.scaled),this.levels.push(e)}this.level=this.levels[0],this.hero.e.currentLevel=0},this.genLevel(0);var e=this.levels[this.hero.e.currentLevel].cols;this.surTiles=[-1,1,e-1,e,e+1,-e-1,-e,1-e],this.update=function(t,e){this.shake=xt?Math.cos(it):0,this.hero.setCurrentTile(this.scaled),W(it),this.level.draw(this.hero.e,t),ot=!1,this.hero.update(ctx,t),bt.canvas.style.cursor="none";let s=ht.x,n=ht.y;if(ctx.fillStyle="WHITE",ctx.globalAlpha=.4,w=8,h=40,ctx.fillRect(s-4,n-20,w,h),ctx.fillRect(s-20,n-4,h,w),this.introT>0){for(i=0;i<=q/33;i++)for(j=0;j<=Q/33;j++)ctx.save(),ctx.translate(32*i,32*j),col=i%2==0&&j%2==0?"#000":"#FFF",ctx.fillStyle=col,ctx.globalAlpha=.5,ctx.fillRect(this.introT/-2,this.introT/-2,this.introT,this.introT),ctx.restore();this.introT-=48*t}}}getSound=function(t,e){var i;switch(t){case Yt:i=a(e);break;case qt:i=g(e);break;case Qt:i=u(e);break;case $t:i=d(e);break;case _t:i=v(e);break;case te:i=p(e);break;case ee:i=k(e);break;case ie:i=M(e);break;default:return 1}return i};const T={FLOOR:1,AIR:2,HERO:3,WALL:4,SPIKE:5},S={FOLLOW:0,SIMPLE:1};function E(t,e,i,s,h,n,o,r,l){this.entity=new U(t,t,e,i,s,h,"",l,0,0),this.column=o,this.row=r,this.active=!0,this.update=function(t){this.entity.update(t)},this.change=function(){this.entity.type>=Object.values(T).length&&(this.entity.type=0),this.entity.setType()},this.isTile=function(){return!0}}function L(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s}function I(){let t="#";for(var e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}var C="Google UK English Female";function H(t){let e=new SpeechSynthesisUtterance;e.text=t,e.voice=speechSynthesis.getVoices().filter(function(t){return t.name==C})[0],speechSynthesis.speak(e)}function R(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function O(t){return new L(t.x,t.y,t.w,t.h)}function B(t,e,i,s,h,n,o,r){return t<h+o&&t+i>h&&e<n+r&&e+s>n}function F(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function K(t,e){this.x=t,this.y=e,this.set=function(t,e){this.x=t,this.y=e}}function W(t){ctx.fillStyle="#FFF";for(let e=2e3;e--;)x=(1e9*Math.sin(e)-t/2e3*(e+1e3)/50)%(bt.canvas.width+9)-9,y=9*e%q,s=e%5,ctx.fillRect(x,y,s,s)}function D(t){for(i=200;i--;ctx.fillRect(q/2+i*Math.sin(i)*Z,423+i*Math.cos(9*i)*Z,Z,Z))ctx.fillStyle="rgba(255,255,255,"+(i+.1)+")",Z=2*Math.tan(i/9+t/3)}function P(t,e,i,s,h,n,o,r,l,a){t.save(),t.globalAlpha=l,t.translate(o,r),t.drawImage(e,i,s,h,n,h/2,n/2,h*a,n*a),t.restore()}function N(t,e,i,s,h,n,o,r,l){t.save(),t.globalAlpha=l,t.translate(e,i),t.fillStyle=r,t.fillRect(s,h,n,o),t.restore()}function G(){q=window.innerWidth,Q=window.innerHeight;let t=0;t=q/Q>4/3?(q=Q*(4/3))/1216:(Q=q/(4/3))/832,gt.scale=t*scale.scale}function J(t,e,i,s,h,n=!1){dt=t,this.tiles=[],this.breakTiles=[],this.mvTiles=[],this.active=!1,this.roomNo=s;function o(t,e,i,s){return 1==e||e==i-2||1==t&&1==e||1==t&&e==i-2||1==t&&e>1&&e<i-2||t==s-2&&e==i-2||t==s-2&&1==e||t==s-2&&e>1&&e<i-2}this.cols=24,this.draw=function(t,e){this.tiles.forEach(t=>t.update(e))},this.reset=function(t,e){for(this.tiles=[],this.dTiles=[],r=0;r<13;r++)for(c=0;c<this.cols;c++){var i;ts=16*h,xx=c*ts,yy=r*ts;var s=T.AIR;0==r||0==c||12==r||c==this.cols?s=T.AIR:10==r&&5==c?s=T.BLOCK:9==r&&5==c?s=T.BLOCK:7==r&&5==c?s=T.BLOCK:9==r&&8==c?s=T.BLOCK:10==r&&10==c?s=T.SPIKE:o(r,c,this.cols,13)&&(s=T.BLOCK),10==r&&11==c&&(s=T.SPIKE),10==r&&12==c&&(s=T.SPIKE),10==r&&13==c&&(s=T.SPIKE),10==r&&14==c&&(s=T.SPIKE),i=new E(16,xx,yy,0,s,!1,c,r,h),this.tiles.push(i)}},this.addAir=function(t){this.tiles[t].entity.setT(T.AIR)},this.addWall=function(t){this.tiles[t].entity.setT(T.WALL)}}function U(t,e,i,h,n,o,r,l,a=!1,c=0){this.scale=l,this.type=o,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWScaled=t/-2*l,this.mhHScaled=e/-2*l,this.hWidth=t/2,this.hHeight=e/2,this.angle=n,this.x=i,this.y=h,this.active=!0,this.colour=r,this.image=yt,this.animated=!1,this.alpha=1,this.currentTile=0,this.colArr=[],this.isSolid=!1,this.isButton=a,this.time=0,this.maxHP=c,this.hp=this.maxHP,this.breaks=!1,this.flip=!1,this.idle=0,this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new L(0,0,0,0),this.sensor=new L(0,0,0,0),this.isButton&&(this.hb.w=2*this.width,this.hb.h=2*this.height)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.scale/2,this.hb.y=this.y+this.scale/2,this.hb.w=this.width*this.scale-this.scale,this.hb.h=this.height*this.scale-this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.update=function(i){this.idle+=i,this.updateHitbox(),this.active&&!this.isFloor()&&(ctx.save(),ctx.translate(this.x,this.y),ctx.rotate(this.angle),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,t=this.width,e=this.height,gt.shakeTime>0&&(gt.shakeTime-=i/1e3,ctx.translate(gt.shake,gt.shake)),null==this.image?(ctx.fillStyle=this.colour,ctx.fillRect(.5*mhw*s,.5*mhh*s,.5*t*s,.5*e*s)):(this.flip?(ctx.scale(-1,1),ctx.translate(-t*s-t,0)):ctx.scale(1,1),f=0,z=0,ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh+f,t*s,e*s)),ctx.restore())},this.isHero=function(){return this.type==T.HERO},this.isTile=function(){return!1},this.setT=function(t){this.type=t,this.setType()},this.isFloor=function(){return this.type==T.FLOOR},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.isSolid=!1,this.type){case T.HERO:this.isSolid=!0,this.sx=0,this.sy=0;break;case T.WALL:this.sy=16;break;case T.BLOCK:this.isSolid=!0,this.sx=16;break;case T.SPIKE:this.sx=48;break;case T.FLOOR:this.sx=32,this.sy=32,this.alpha=.9;break;case T.AIR:this.sx=144}},this.setType()}function V(t,i,s,h,n,o,r){this.e=new U(t,i,s,h,n,o,"",r,!1,100),this.e.hp=100;let a=null,c=!1,u=0,f=0,d=0,y=.1,x=Ot,g={x:this.e.x,y:this.e.y};this.hereos=[];let v=[],p=0;this.update=function(t,e){var i,s;this.time+=e,u=Tt()||St()?u>6?6:u+=.5:u>0?u-=.5:0,(Tt()||u>0&&x==Rt)&&(x=Rt,this.e.x-=this.gMove(-1,0),this.e.flip=!0),(St()||u>0&&x==Ot)&&(x=Ot,this.e.x+=this.gMove(1,0),this.e.flip=!1),d<=0&&this.grounded()?c=!1:d>0&&(this.e.y-=this.gMove(0,-1,!1,!0),d-=e),this.canFall&&y>=.1?this.e.y+=this.gMove(0,1,!0,!1):this.grounded()||(y+=e),this.grounded()&&0!=y&&!c&&(y=0),null!=a&&a.entity.type==T.SPIKE&&(console.log("death"),this.hereos.push(v),v=[],this.e.x=150,this.e.y=300),(Et()||It())&&this.jump(),this.hereos.forEach((e,i)=>(function t(e,i,s,h){i.constructor===Array&&p>0&&s==h?i.forEach(i=>t(e,i)):p>0&&P(e,this.e.image,0,0,this.e.width,this.e.height,i.x,i.y,p,r);if(i.constructor===Array){let t=i[i.length-1];P(e,this.e.image,0,0,this.e.width,this.e.height,t.x,t.y,.6,r)}})(t,e,i,this.hereos.length-1)),this.e.update(e),g.x==this.e.x&&g.y==this.e.y||(i=this.e.x,s=this.e.y,v.push({x:i,y:s,d:x}),g={x:this.e.x,y:this.e.y}),Ht()&&this.hereos.length>0&&(p=.1,this.hereos[this.hereos.length-1].pop(),0==this.hereos[this.hereos.length-1].length&&this.hereos.splice(this.hereos.length-1,1)),p>0&&(p-=e)},this.setCurrentTile=function(t){heroRow=Math.floor((this.e.y-this.e.mhHScaled)/t),heroCol=Math.floor((this.e.x-this.e.mhWScaled)/t),heroTileIndex=heroCol+gt.levels[this.e.currentLevel].cols*heroRow,null!=a&&(this.prevTile=a),(a=gt.level.tiles[heroTileIndex])!=this.prevTile&&(console.log("Hero Moved: "+this.e.colArr.length),this.e.colArr=[],console.log("Cleared tiles: "+this.e.colArr.length),gt.surTiles.forEach(t=>this.e.colArr.push(gt.level.tiles[heroTileIndex+t])),console.log("Added Surrounding tiles: "+this.e.colArr.length),console.log("Add bodies: "+this.e.colArr.length),this.hereos.forEach(t=>(function(t,e){console.log("Add Body: "+e.length);let i=t[t.length-1],s=new E(16,i.x,i.y,0,T.BLOCK,!1,0,0,r);s.entity.updateHitbox(),console.log(s),e.push(s),console.log("Added Body: "+e.length)})(t,this.e.colArr)),console.log("Final Count: "+this.e.colArr.length))},this.canFall=function(){return this.gMove(0,1,!1,!1,!0)>0},this.jump=function(){!c&&y<=.1&&(y=.1,c=!0,d=.5,f=16,l(Qt,.2))},this.grounded=function(){rec=O(this.e.hb),rec.y+=2,canJump=!1;for(var t=0;t<this.e.colArr.length;t++)if(obj=this.e.colArr[t],e=obj.entity,obj.isTile()&&F(e.hb,rec)&&obj.active&&e.isSolid&&rec.y>this.e.y){canJump=!0;break}return canJump},this.gMove=function(t,i,s=!1,h=!1,n=!1){this.e.idle=0;var o=s?7:u;h?o=f=(f-=.3)>0?f:0:n&&(o=1),rec=O(this.e.hb),rec.x+=t*o,rec.y+=i*o,canMove=!0,amount=o;for(var r=o;r>0;r--){canMove=!0;for(var l=0;l<this.e.colArr.length;l++)if(obj=this.e.colArr[l],e=obj.entity,obj.isTile()){if(F(e.hb,rec)&&obj.active&&e.isSolid){canMove=!1;break}}else if(obj.active&&obj.isSolid&&F(obj.hb,rec)){canMove=!1;break}if(canMove)break;amount--,rec.x-=t,rec.y-=i}return amount}}let X,Y,q=window.innerWidth,Q=window.innerHeight,$=!0,_=0,tt=Date.now(),et=Date.now(),it=0,st=0,ht=new K(0,0),nt=new K(0,0),ot=!1,rt=!1,lt=0,at=!1,ct="990099",ut="05f2db",ft=!1,dt=1,yt=new Image;yt.src="atlas.png";let xt=!0,gt=new A,vt=speechSynthesis.getVoices(),pt=!0;n=new AudioContext;let wt=!1;function startGame(){bt.start()}let bt={canvas:document.createElement("canvas"),start:function(){this.canvas.width=q,this.canvas.height=Q,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),ctx=this.context,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(mt,20),window.addEventListener("keydown",function(t){t.preventDefault(),bt.keys=bt.keys||[],bt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){bt.keys[t.keyCode]="keydown"==t.type,t.keyCode==Gt&&(xt=!xt),t.keyCode==Jt&&(gt.bkcol=I()),t.keyCode==Xt&&(at=!0)}),window.addEventListener("mousedown",function(t){t.preventDefault(),bt.keys=bt.keys||[],bt.keys[t.button]=!0,rt=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),bt.keys=bt.keys||[],bt.keys[t.button]=!1,rt=!1,lt=0,ot=!0,!wt&&it>2e3&&(wt=!0),kt()}),window.addEventListener("mousemove",function(t){t.preventDefault();let e=bt.canvas.getBoundingClientRect();ht.set((t.clientX-e.left)/(e.right-e.left)*q,(t.clientY-e.top)/(e.bottom-e.top)*Q),row=Math.floor(ht.y/this.scaled),col=Math.floor(ht.x/this.scaled),kt()}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function kt(){nt.set(ht.x,ht.y)}function mt(){if(at){it=0,gt.hero.e.hp=100,at=!1,ft=!1,dt=0,wt=!1,$=!1,gt.genLevel(dt)}wt&&it>2e3&&(null!=gt.hero&&(gt.hero.e.active=!0),$=!0,null==n&&(n=new AudioContext)),tt=et,et=Date.now(),it+=_=et-tt,$?(bt.clear(),gt.update(_/1e3,it)):(bt.clear(),ctx=bt.context,ctx.save(),Mt(ctx,.1,"#"+ct,0,0,q,Q),txt=it>2e3?"[ CLICK TO START ]":"[ LOADING ]",At(ctx,1,"italic 50px Arial","WHITE",txt,380,720),z=it/1600,At(ctx,1,"italic 60px Arial","WHITE","Death Counts",50+40*Math.cos(z),150+20*Math.sin(z)),At(ctx,1,"italic 30px Arial","WHITE","Die to live!",50+70*Math.cos(z),230+20*Math.sin(z)))}function Mt(t,e,i,s,h,n,o){t.globalAlpha=e,t.fillStyle=i,t.fillRect(s,h,n,o)}function At(t,e,i,s,h,n,o){t.globalAlpha=e,t.font=i,t.fillStyle=s,t.fillText(h,n,o)}function Tt(){return bt.keys&&(bt.keys[Rt]||bt.keys[Kt])}function St(){return bt.keys&&(bt.keys[Ot]||bt.keys[Dt])}function Et(){return bt.keys&&(bt.keys[jt]||bt.keys[Ft])}function Lt(){return bt.keys&&(bt.keys[Bt]||bt.keys[Wt])}function It(){return bt.keys&&bt.keys[Zt]}function Ct(){return bt.keys&&bt.keys[Pt]}function Ht(){return bt.keys&&bt.keys[Gt]}var Rt=37,Ot=39,jt=38,Bt=40,Ft=87,Kt=65,Wt=83,Dt=68,Pt=77,zt=0,Nt=2,Zt=32,Gt=49,Jt=50,Ut=51,Vt=52,Xt=82,Yt=0,qt=1,Qt=2,$t=3,_t=4,te=5,ee=6,ie=7;