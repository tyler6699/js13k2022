var h,n,a={songData:[{i:[3,162,128,0,3,0,128,0,0,0,5,6,45,0,0,0,0,0,6,1,2,255,0,6,69,0,6,0,6],p:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,27,33,27,33,27,33,27,33],c:[{n:[113,,113,113,113,,113,113,,108,113,108,115,116,111,108,,113,113,,113,,113,113,,108,113,108,115,116,111,115],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[121,,121,121,121,,121,121,,116,121,116,123,125,116,121,,120,120,,120,,120,120,,111,115,111,118,120,123,125],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[118,,118,118,118,,118,118,,113,118,113,120,121,123,115,,115,115,,115,,115,115,,113,111,113,115,116,118,120],f:[]}]},{i:[0,119,128,64,3,0,128,0,0,0,0,0,43,0,0,0,0,0,6,1,2,255,117,3,212,0,6,0,6],p:[,,,,2,2,2,,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],c:[{n:[],f:[]},{n:[125,,,125,,,125,125,,,125,,,,,,,,125,125,,,,125,,,125],f:[]}]},{i:[2,0,128,0,3,0,128,0,0,196,5,6,41,0,0,0,0,0,6,1,2,149,0,0,116,0,6,27,6],p:[,,,7,3,3,3,7,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],c:[{n:[],f:[]},{n:[],f:[]},{n:[,,,,137,,,,,,,,137,,,,,,,,137,,,,,,,,137,,137,137],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,137,,137,137],f:[]}]},{i:[2,0,128,0,3,0,128,0,0,131,5,6,29,0,0,0,0,0,6,1,1,135,0,0,32,147,6,92,2],p:[,,4,8,4,4,4,8,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[185,,,185,,,185,,,185,,,185,185,,,185,,,185,,,185,,,185,,,185,185],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[185,,,185,,,185,,,185,,,185,185],f:[]}]},{i:[2,100,128,0,1,201,128,0,0,0,5,6,44,0,0,0,0,0,6,1,2,83,0,0,5,147,6,45,6],p:[,,,,5,5,5,5,5,5,5,5,5,5,5,5,11,29,11,29,11,29,11,29],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[137,137,137,,137,137,,137,,137,137,,137,137,,137,,125,125,,137,137,,137,,137,137,,137,137,,137,140,140,140,,140,140,,140,,140,140,,140,140,,140,,128,128,,140,140,,140,,140,140,,140,140,,140,144,144,144,,144,144,,144,,144,144,,144,144,,144,,132,132,,144,144,,144,,144,144,,144,144,,144,147,147,147,,147,147,,147,,147,147,,147,147,,147,,135,135,,147,147,,147,,147,147,,147,147,,147],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[137,137,137,,137,137,,137,,137,137,,137,137,,137,,123,123,,135,135,,135,,135,135,,135,135,,135,140,140,140,,140,140,,140,,140,140,,140,140,,140,,127,127,,139,139,,139,,139,139,,139,139,,139,144,144,144,,144,144,,144,,144,144,,144,144,,144,,130,130,,142,142,,142,,142,142,,142,142,,142,147,147,147,,147,147,,147,,147,147,,147,147,,147,,132,132,,144,144,,144,,144,144,,144,144,,144],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[137,137,137,,137,137,,137,,137,137,,137,137,,137,,123,123,,135,135,,135,,135,135,,135,135,,135,140,140,140,,140,140,,140,,140,140,,140,140,,140,,127,127,,139,139,,139,,139,139,,139,139,,139,142,142,142,,142,142,,142,,142,142,,142,142,,142,,130,130,,142,142,,142,,142,142,,142,142,,142,145,145,145,,145,145,,145,,145,145,,145,145,,145,,133,133,,145,145,,145,,145,145,,145,145,,145],f:[]}]},{i:[1,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,0,6,1,2,188,53,0,32,0,6,27,6],p:[,,,,,,,,6,9,6,10,6,9,6,10,36,34,13,32,36,34,13,32],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,,,152,,,,151,,147,,,,154,,,,152,,,,151,,,,147,,144,,142],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,,,152,,,,151,,147,,,,154,,,,156,,,,144,,154,,152,,151,,152],f:[]},{n:[,,,,152,,,,151,,147,,,,140,,151,,152,,142,,154,,156,,144,,159,,161],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,,,149,,,,152,,,,157,,,,159,,,,161,,159,,,,152,,163,,164],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[,,166,,164,,163,,159,,,,,,164,,163,,159,,156,,,,154,156,157,159,161,156,152,151],f:[]},{n:[],f:[]},{n:[,,157,,156,,152,,149,,,,147,,149,,151,,152,,151,,147,,142,140,139,140,142,144,145,147],f:[]},{n:[],f:[]},{n:[,,,,149,,,,152,,,,157,,,,159,,,,161,,159,,,,152,,156,,157],f:[]}]}],rowLen:5088,patternLen:32,endPattern:23,numChannels:6},o=!1,l=!1,u=function(){var t,e,i,s,h,n=function(t){return Math.sin(6.283184*t)},a=function(t){return.003959503758*Math.pow(2,(t-128)/12)},r=function(t,e,i){var s,h,n,r,l,c,f,u=o[t.i[0]],d=t.i[1],y=t.i[3],p=o[t.i[4]],x=t.i[5],v=t.i[8],g=t.i[9],w=t.i[10]*t.i[10]*4,m=t.i[11]*t.i[11]*4,b=t.i[12]*t.i[12]*4,k=1/b,M=t.i[13],S=i*Math.pow(2,2-t.i[14]),T=new Int32Array(w+m+b),E=0,L=0;for(s=0,h=0;s<w+m+b;s++,h++)h>=0&&(h-=S,c=a(e+(15&(M=M>>8|(255&M)<<4))+t.i[2]-128),f=a(e+(15&M)+t.i[6]-128)*(1+8e-4*t.i[7])),n=1,s<w?n=s/w:s>=w+m&&(n-=(s-w-m)*k),r=c,y&&(r*=n*n),l=u(E+=r)*d,r=f,v&&(r*=n*n),l+=p(L+=r)*x,g&&(l+=(2*Math.random()-1)*g),T[s]=80*l*n|0;return T},o=[n,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var e=t%1*4;return e<2?e-1:3-e}];this.init=function(n){t=n,e=n.endPattern,i=0,s=n.rowLen*n.patternLen*(e+1)*2,h=new Int32Array(s)},this.generate=function(){var a,l,c,f,u,d,y,p,x,v,g,w,m,b,k=new Int32Array(s),M=t.songData[i],S=t.rowLen,T=t.patternLen,E=0,L=0,A=!1,O=[];for(c=0;c<=e;++c)for(y=M.p[c],f=0;f<T;++f){var I=y?M.c[y-1].f[f]:0;I&&(M.i[I-1]=M.c[y-1].f[f+T]||0,I<16&&(O=[]));var P=o[M.i[15]],D=M.i[16]/512,R=Math.pow(2,M.i[17]-9)/S,j=M.i[18],C=M.i[19],H=43.23529*M.i[20]*3.141592/44100,W=1-M.i[21]/255,K=1e-5*M.i[22],B=M.i[23]/32,N=M.i[24]/512,F=6.283184*Math.pow(2,M.i[25]-9)/S,U=M.i[26]/255,z=M.i[27]*S&-2;for(g=(c*T+f)*S,u=0;u<4;++u)if(d=y?M.c[y-1].n[f+u*T]:0){O[d]||(O[d]=r(M,d,S));var J=O[d];for(l=0,a=2*g;l<J.length;l++,a+=2)k[a]+=J[l]}for(l=0;l<S;l++)(v=k[p=2*(g+l)])||A?(w=H,j&&(w*=P(R*p)*D+.5),L+=(w=1.5*Math.sin(w))*(m=W*(v-L)-(E+=w*L)),v=3==C?L:1==C?m:E,K&&(v=(v*=K)<1?v>-1?n(.25*v):-1:1,v/=K),A=(v*=B)*v>1e-5,b=v*(1-(x=Math.sin(F*p)*N+.5)),v*=x):b=0,p>=z&&(b+=k[p-z+1]*U,v+=k[p-z]*U),k[p]=0|b,k[p+1]=0|v,h[p]+=0|b,h[p+1]+=0|v}return++i/t.numChannels},this.createWave=function(){var t=44+2*s-8,e=t-36,i=new Uint8Array(44+2*s);i.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(var n=0,a=44;n<s;++n){var r=h[n];r=r<-32767?-32767:r>32767?32767:r,i[a++]=255&r,i[a++]=r>>8&255}return i},this.getData=function(t,e){for(var i=2*Math.floor(44100*t),s=new Array(e),n=0;n<2*e;n+=1){var a=i+n;s[n]=t>0&&a<h.length?h[a]/32768:0}return s}};function d(){var t=new u;t.init(a),setInterval(function(){if(!o&&(o=t.generate()>=1)){var e=t.createWave();(h=document.createElement("audio")).src=URL.createObjectURL(new Blob([e],{type:"audio/wav"})),l=!0}},0)}function p(t,e,i,s,h,n,a,r=Ft){this.time=0,this.x=i,this.y=s,this.w=t,this.h=e,this.type=n,this.endPos=Q(this),this.speed=7,this.angle=Math.atan2(this.endPos.y-this.y,this.endPos.x-this.x),this.remove=!1,this.alpha=1,this.colour="#"+["FF0000","B30000","7D0000","FF8080"][B(0,3)],this.no=1,"dust"==this.type&&(this.colour="#"+["4d1933","EDEDED"][B(0,1)],this.alpha=.1),this.rndCol=a,this.lastDir=r,this.update=function(t,e){if(this.time+=e,t.save(),t.translate(St.cam.x,St.cam.y),"circle"==this.type){let e=Math.atan2(this.y-this.endPos.y,this.x-this.endPos.x)+Math.PI+2*(Math.random()-.5);Math.hypot(this.endPos.x-this.x,this.endPos.y-this.y)>=10&&(this.x+=Math.cos(e)*this.speed-6*this.time,this.y+=Math.sin(e)*this.speed-6*this.time),this.alpha-=.01,this.w>1&&(this.w-=.75),t.beginPath(),t.globalAlpha=this.alpha,t.arc(this.x,this.y,this.w,0,6.283185307179586);let i=this.rndCol?H():this.colour;t.fillStyle=i,t.fill(),this.time>.6&&(this.remove=!0)}else if("dust"==this.type)this.lastDir==Ft?this.x-=2:this.x+=2,this.y-=B(1,5)/10,t.beginPath(),t.globalAlpha=this.alpha,t.arc(this.x,this.y,this.w,0,6.283185307179586),t.fillStyle=this.colour,t.fill(),this.alpha>.1&&(this.alpha-=.01),this.w+=.1,this.time>.5&&(this.remove=!0);else if("bld"==this.type){t.beginPath(),t.globalAlpha=this.alpha;for(let e=0;e<=this.no;e++)t.arc(this.x,this.y+e,this.w,0,6.283185307179586),t.fillStyle=this.colour,t.fill();B(1,10)>8&&this.no++,this.alpha-=.01,(this.time>2.5||this.alpha<=0)&&(this.remove=!0)}t.globalAlpha=1,t.restore()}}function v(t=0,e=0){this.x=t,this.y=e}var g=[];function w(t,e){for(m=n.createBuffer(1,96e3,48e3),gainNode=n.createGain(),b=m.getChannelData(0),i=96e3;i--;)b[i]=getSound(t,i);s=n.createBufferSource(),s.buffer=m,s.connect(gainNode),gainNode.connect(n.destination),gainNode.gain.value=e,s.start()}function k(e){if(t=((t,e)=>(e-t)/e),e>7e4)return null;t(e,7e4);return Math.sin(.001*e*Math.sin(.009*e)+Math.sin(e/100))}function M(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return(128&Math.pow(t,1.055)?1:-1)*Math.pow(e,2)}function S(t){if(t>5e4)return null;var e=(5e4-t)/5e4;return(200&Math.pow(t,.9)?1:-1)*Math.pow(e,3)}function T(t){var e=1e4;if(t>e)return null;var i=(e-t)/e,s=Math.pow(i,2.1);return Math.pow(t,3)&(t<3333.3333333333335?16:99)?s:-s}function E(t){if(t>2e4)return null;var e=(2e4-t)/2e4;return Math.sin(.003*-t*Math.sin(.09*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function L(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return Math.sin(.01*t*Math.sin(.009*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function A(e){if(e>2e3)return null;t=((t,e)=>(e-t)/e);var i=t(e,2e3);return 33&Math.pow(50*e,.7)?i:-i}function O(e){if(t=((t,e)=>(e-t)/e),e>2e4)return null;var i=t(e,2e4);return e*=.04,Math.sin(.03*-e*Math.sin(.09*e+Math.sin(e/200))+Math.sin(e/100))*i}function I(){var t=!0;this.cam=new v,this.ratio=0,st>800?(this.ratio=st/800,console.log("Wider: "+this.ratio)):(this.ratio=st/800,console.log("High Screen: "+this.ratio)),this.scale=2,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new tt(16,16,40*this.scale,100*this.scale,0,P.HERO,this.scale),this.introT=0,this.shake=0,this.shakeTime=0,this.reset=!1,this.wait=2,this.genLevel=function(t){this.levels=[];let e=[64,0];for(i=0;i<1;i++){var s=new $(t,st,ht,i,this.scale,e[i]);s.reset(i,this.scaled),this.levels.push(s)}this.level=this.levels[0],this.hero.e.curLevel=0},this.genLevel(0);var e=this.levels[this.hero.e.curLevel].cols;this.surTiles=[-1,1,e-1,e,e+1,-e-1,-e,1-e],this.update=function(e,s){if(t&&(t=!1,ctx.scale(this.ratio,this.ratio)),this.shake=Mt?Math.cos(lt):0,this.hero.setCurrentTile(this.scaled),G(lt),this.level.draw(this.hero,e),dt=!1,this.hero.update(ctx,e),At.canvas.style.cursor="none",this.introT>0){for(i=0;i<=st/33;i++)for(j=0;j<=ht/33;j++)ctx.save(),ctx.translate(32*i,32*j),col=i%2==0&&j%2==0?"#000":"#FFF",ctx.fillStyle=col,ctx.globalAlpha=.5,ctx.fillRect(this.introT/-2,this.introT/-2,this.introT,this.introT),ctx.restore();this.introT-=48*e}vt&&(vt=!1,this.levels[this.hero.e.curLevel].reset(),this.hero.reset())}}getSound=function(t,e){var i;switch(t){case he:i=k(e);break;case ne:i=T(e);break;case ae:i=M(e);break;case re:i=S(e);break;case oe:i=E(e);break;case le:i=L(e);break;case ce:i=A(e);break;case fe:i=O(e);break;default:return 1}return i};const P={BLOCK:0,FLOOR:1,AIR:2,HERO:3,WALL:4,SPIKE:5,TONNE:6,LSPIKE:7,RSPIKE:8,TSPIKE:9,BUTTON:10,PORTAL:11,DOOR:12},D={FOLLOW:0,SIMPLE:1};function R(t,e,i,s,h,n,a,r,o,l){this.entity=new _(t,t,e,i,s,h,"",o,0,0),this.column=a,this.row=r,this.active=!0,this.trigger=l,this.update=function(t){this.entity.update(t)},this.change=function(){this.entity.type>=Object.values(P).length&&(this.entity.type=0),this.entity.setType()},this.isTile=function(){return!0}}function C(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s}function H(){let t="#";for(var e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}var W="Google UK English Female";function K(t){let e=new SpeechSynthesisUtterance;e.text=t,e.voice=speechSynthesis.getVoices().filter(function(t){return t.name==W})[0],speechSynthesis.speak(e)}function B(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function N(t){return new C(t.x,t.y,t.w,t.h)}function F(t,e,i,s,h,n,a,r){return t<h+a&&t+i>h&&e<n+r&&e+s>n}function U(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function J(t,e){this.x=t,this.y=e,this.set=function(t,e){this.x=t,this.y=e}}function G(t){ctx.fillStyle="#FFF";for(let e=2e3;e--;)x=(1e9*Math.sin(e)-t/2e3*(e+1e3)/50)%(At.canvas.width+9)-9,y=9*e%st,s=e%5,ctx.fillRect(x,y,s,s)}function X(t){for(i=200;i--;ctx.fillRect(st/2+i*Math.sin(i)*Z,423+i*Math.cos(9*i)*Z,Z,Z))ctx.fillStyle="rgba(255,255,255,"+(i+.1)+")",Z=2*Math.tan(i/9+t/3)}function Y(t,e,i,s,h,n,a,r,o,l,c=0){t.save(),t.globalAlpha=o,t.translate(a,r),c>0&&(t.translate(24,24),t.rotate(c*Math.PI/180),t.translate(-24,-24)),t.drawImage(e,i,s,h,n,h/2,n/2,h*l,n*l),t.restore()}function V(t,e,i,s,h,n,a,r,o){t.save(),t.globalAlpha=o,t.translate(e,i),t.fillStyle=r,t.fillRect(s,h,n,a),t.restore()}function q(){st=window.innerWidth,ht=window.innerHeight;let t=0;t=st/ht>4/3?(st=ht*(4/3))/1216:(ht=st/(4/3))/832,St.scale=t*scale.scale}function Q(t){var e=B(0,360)*Math.PI/180,i=B(50,180),s=[-1,1][B(0,1)]*i;return{x:t.x+s*Math.cos(e),y:t.y+s*Math.sin(e)}}function $(t,e,i,s,h,n){bt=t,this.tiles=[],this.triggers=[],this.breakTiles=[],this.mvTiles=[],this.active=!1,this.roomNo=s,this.opendoors=!1,this.startPos=[40,100];this.cols=24;let a=0;this.doorDrop=n,this.draw=function(t,e){this.tiles.forEach(t=>t.update(e)),this.opendoors&&this.mvTiles.forEach(t=>{t.entity.isSolid=!1,a<this.doorDrop?(t.entity.y+=2,a+=1):t.entity.active&&(St.shakeTime=.1,t.entity.active=!1)}),this.triggers.forEach((e,i)=>{if(!e.trigger)return;e.entity.x,e.entity.hWidth;if(e.entity.type==P.TONNE){let i=t.e.x,s=t.e.x+t.e.width*h,n=e.entity.x,a=e.entity.x+e.entity.width*h;(i>n&&i<a||s>n&&s<a)&&t.e.y-t.e.height>e.entity.y&&(e.entity.y+=30),U(t.e.hb,e.entity.hb)&&(t.kill(),e.trigger=!1)}})},this.reset=function(t,e){this.tiles=[],this.dTiles=[],this.mvTiles=[],this.opendoors=!1,a=0;let i=!1;for(r=0;r<13;r++)for(c=0;c<this.cols;c++){var s;i=!1,ts=16*h,xx=c*ts,yy=r*ts;var n=P.AIR;11==r&&(n=P.BLOCK),10==r&&5==c&&(n=P.BLOCK),0==c&&(n=P.BLOCK),1==c&&9==r&&(n=P.RSPIKE),1==c&&8==r&&(n=P.RSPIKE),10==r&&c>5&&c<16&&(n=P.SPIKE),15==c&&r<10&&r>5&&(n=P.LSPIKE),16==c&&r<10&&r>5&&(n=P.BLOCK),10==r&&16==c&&(n=P.BLOCK),10==r&&4==c&&(n=P.BUTTON),8==r&&20==c&&(n=P.PORTAL),9==r&&5==c&&(n=P.DOOR),8==r&&5==c&&(n=P.DOOR),n==P.TONNE&&(i=!0),s=new R(16,xx,yy,0,n,!1,c,r,h,i),this.tiles.push(s),1==s.trigger&&this.triggers.push(s),n==P.DOOR&&this.mvTiles.push(s)}},this.addAir=function(t){this.tiles[t].entity.setT(P.AIR)},this.addWall=function(t){this.tiles[t].entity.setT(P.WALL)}}function _(t,e,i,h,n,a,r,o,l=!1,c=0){this.scale=o,this.type=a,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWScaled=t/-2*o,this.mhHScaled=e/-2*o,this.hWidth=t/2,this.hHeight=e/2,this.cenX=i-this.mhWScaled,this.cenY=h-this.mhHScaled,this.angle=n,this.x=i,this.y=h,this.active=!0,this.colour=r,this.image=kt,this.animated=!1,this.alpha=1,this.currentTile=0,this.colArr=[],this.isSolid=!1,this.isButton=l,this.time=0,this.maxHP=c,this.hp=this.maxHP,this.breaks=!1,this.flip=!1,this.idle=0,this.pressed=!1,this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new C(0,0,0,0),this.sensor=new C(0,0,0,0),this.isButton&&(this.hb.w=2*this.width,this.hb.h=2*this.height)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.scale/2,this.hb.y=this.y+this.scale/2,this.hb.w=this.width*this.scale-this.scale,this.hb.h=this.height*this.scale-this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.update=function(i){this.idle+=i,this.updateHitbox(),this.active&&!this.isFloor()&&(ctx.save(),ctx.translate(this.x,this.y),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,t=this.width,e=this.height,St.shakeTime>0&&(St.shakeTime-=i/1e3,ctx.translate(St.shake,St.shake)),ctx.translate(St.cam.x,St.cam.y),null==this.image?(ctx.fillStyle=this.colour,ctx.fillRect(.5*mhw*s,.5*mhh*s,.5*t*s,.5*e*s)):(this.flip?(ctx.scale(-1,1),ctx.translate(-t*s-t,0)):ctx.scale(1,1),f=0,z=0,this.angle>0&&(ctx.translate(24,24),ctx.rotate(this.angle*Math.PI/180),ctx.translate(-24,-24)),ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh+f,t*s,e*s)),ctx.restore()),this.cenX=this.x-this.mhWScaled,this.cenY=this.y-this.mhHScaled},this.isHero=function(){return this.type==P.HERO},this.isTile=function(){return!1},this.setT=function(t){this.type=t,this.setType()},this.isFloor=function(){return this.type==P.FLOOR},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.isSolid=!1,this.type){case P.HERO:this.isSolid=!0,this.sx=0,this.sy=0;break;case P.WALL:this.sy=16;break;case P.BLOCK:this.isSolid=!0,this.sx=16;break;case P.DEAD:this.isSolid=!0;case P.SPIKE:this.sx=48;break;case P.LSPIKE:this.sx=48,this.angle=270;break;case P.RSPIKE:this.sx=48,this.angle=90;break;case P.TSPIKE:this.sx=48,this.angle=180;break;case P.TONNE:this.sx=48,this.sy=16;break;case P.BUTTON:this.sx=64;break;case P.FLOOR:this.sx=32,this.sy=32,this.alpha=.9;break;case P.PORTAL:this.sx=64,this.sy=16,this.alpha=.9;break;case P.AIR:this.sx=144;break;case P.DOOR:this.isSolid=!0,this.sx=32}},this.setType()}function tt(t,i,s,h,n,a,r){this.e=new _(t,i,s,h,n,a,"",r,!1,100),this.hereos=[],this.active=!0,this.hp=5,this.particles=[];let o=null,l=!1,c=0,f=0,u=0,d=0,y=0,x=0,v=.1,g=Ft,m={x:this.e.x,y:this.e.y},b=[],k=0,M=.1,S=0,T=0,E=0,L=0,A=!1;this.update=function(t,e){if(this.time+=e,f+=e,(Math.abs(m.x-this.e.x)>20||Math.abs(m.y-this.e.y)>20)&&(!function(t,e,i){i.length>8&&i.splice(0,1);i.push({x:t,y:e,d:g})}(this.e.x,this.e.y,b),m={x:this.e.x,y:this.e.y}),this.active?(Rt()||jt()?(this.e.angle+=20,S+=e,u=u>6?6:u+=.5):(u=u>0?u-=.5:0,f<3&&(this.e.angle=0),S=0),(Rt()||u>0&&g==Nt)&&(g=Nt,this.e.x-=this.gMove(-1,0),this.e.flip=!0,!Rt()&&this.grounded()&&this.addDust()),(jt()||u>0&&g==Ft)&&(g=Ft,this.e.x+=this.gMove(1,0),this.e.flip=!1,!jt()&&this.grounded()&&this.addDust())):1==this.hp&&T>0&&(T-=e)<=0&&(this.active=!0,this.e.sy=0),y<=0&&this.grounded()?l=!1:y>0&&(this.e.y-=this.gMove(0,-1,!1,!0),y-=e),x>0&&(x-=e),(Ct()||Wt())&&this.jump(),this.canFall&&v>=.1?this.e.y+=this.gMove(0,1,!0,!1):this.grounded()||(v+=e),this.grounded()&&0!=v&&!l&&(v=0),this.grounded()||(S=0),null!=o){let t=o.entity.type;t==P.SPIKE||t==P.LSPIKE||t==P.RSPIKE||t==P.TSPIKE?(this.bloodSplatter(!1,E,L),this.bloodDrip(o.entity),this.kill()):t!=P.BUTTON||o.entity.pressed?t==P.PORTAL&&(console.log("DONE"),this.bloodSplatter(!0,E,L)):(St.shakeTime=.1,o.entity.pressed=!0,o.entity.sx=80,St.levels[this.e.curLevel].opendoors=!0,w(ne,.8))}(Ct()||Wt()||Bt()||jt()||Rt())&&(f=0),f>3&&(this.e.angle+=40,this.particles.push(new p(B(10,30),0,this.e.x-this.e.mhWScaled,this.e.y+2.2*this.e.height-B(1,5),0,"dust",!1,g)),f>5&&(f=0)),t.save(),t.translate(St.cam.x,St.cam.y),this.hereos.forEach((e,i)=>(function t(e,i,s,h){i.constructor===Array&&k>0&&s==h?i.forEach((s,h)=>t(e,s,h,i.length-1)):k>0&&Y(e,this.e.image,0,16,this.e.width,this.e.height,i.x,i.y,s/h+.3,r);if(i.constructor===Array){let t=i[i.length-1];null!=t&&Y(e,this.e.image,0,16,this.e.width,this.e.height,t.x,t.y,.7,r)}})(t,e,i,this.hereos.length-1)),t.restore();for(let e=1;e<this.hp;e++)Y(t,this.e.image,0,0,this.e.width,this.e.height,2*this.e.width*e,2*this.e.height,1,r);for(let i=0;i<=this.particles.length-1;i++)this.particles[i].update(t,e);if(this.e.update(e),Bt()&&this.active&&this.hereos.length>0)if(k=.1,M<=0){M=.1;let t=this.hereos[this.hereos.length-1],e=1==t.length?t[0]:t[t.length-2];rec=new C(e.x,e.y,this.e.hb.w,this.e.hb.h),U(this.e.hb,rec)&&this.active||(this.hereos[this.hereos.length-1].pop(),0==this.hereos[this.hereos.length-1].length&&(this.hereos.splice(this.hereos.length-1,1),this.hp++,this.active=!0))}else M-=e;k>0&&(k-=e),S>.35&&this.addDust(),this.particles=this.particles.filter(function(t){return 0==t.remove}),this.grounded()?(c>.8&&(this.addDust(!0),St.shakeTime=.08),c=0):c+=e,E=this.e.x-this.e.mhWScaled,L=this.e.y-this.e.mhHScaled,A&&(A=!1,u=0,this.kill())},this.reset=function(){this.hereos=[],this.particles=[],this.hp=2;let t=St.levels[this.e.curLevel];this.e.x=t.startPos[0]*r,this.e.y=t.startPos[1]*r},this.kill=function(){St.shakeTime=.15,w(le,1),this.hp>0&&(this.hp--,this.hereos.push(b),b=[],this.e.x=St.levels[this.e.curLevel].startPos[0]*r,this.e.y=St.levels[this.e.curLevel].startPos[1]*r,0==this.hp&&(this.active=!1,this.hereos.splice(this.hereos.length-1,1),this.hp++,this.e.sy=16,T=.4,u=0))},this.setCurrentTile=function(t){heroRow=Math.floor((this.e.y-this.e.mhHScaled)/t),heroCol=Math.floor((this.e.x-this.e.mhWScaled)/t),heroTileIndex=heroCol+St.levels[this.e.curLevel].cols*heroRow,null!=o&&(this.prevTile=o),o=St.level.tiles[heroTileIndex],this.e.x==m.x&&this.e.y==m.y||(this.e.colArr=[],St.surTiles.forEach(t=>this.e.colArr.push(St.level.tiles[heroTileIndex+t])),this.hereos.forEach(t=>(function(t,e){let i=t[t.length-1];if(null!=i){let t=new R(16,i.x,i.y,0,P.DEAD,!1,0,0,r,!1);t.entity.updateHitbox(),e.push(t)}})(t,this.e.colArr)))},this.addDust=function(t=!1){if(t)for(let t=0;t<B(5,10);t++)this.particles.push(new p(B(5,10),0,this.e.x-this.e.mhWScaled,this.e.y+2.2*this.e.height-B(1,5),0,"dust",!1,Ft)),this.particles.push(new p(B(5,10),0,this.e.x-this.e.mhWScaled,this.e.y+2.2*this.e.height-B(1,5),0,"dust",!1,Nt));else for(let t=0;t<B(1,4);t++)this.particles.push(new p(B(1,15),0,this.e.x-this.e.mhWScaled,this.e.y+2.2*this.e.height-B(1,5),0,"dust",!1,g));S=0},this.canFall=function(){return this.gMove(0,1,!1,!1,!0)>0},this.jump=function(){(!l&&v<=.1&&this.active||this.wRide()&&x<=0)&&(x=.2,v=.1,l=!0,y=.5,d=14,w(ae,.2))},this.grounded=function(){rec=N(this.e.hb),rec.y+=2,canJump=!1;for(var t=0;t<this.e.colArr.length;t++)if(obj=this.e.colArr[t],null!=obj&&null!=obj.entity&&(e=obj.entity,obj.isTile()&&U(e.hb,rec)&&obj.active&&e.isSolid&&rec.y>this.e.y)){canJump=!0;break}return canJump},this.wRide=function(){rec=N(this.e.hb),rec.x-=8,rec.w+=16,rec.y+=2,rec.h+=4,canJump=!1;for(var t=0;t<this.e.colArr.length;t++)if(obj=this.e.colArr[t],null!=obj&&null!=obj.entity&&(e=obj.entity,obj.isTile()&&obj.entity.type==P.DEAD&&U(e.hb,rec)&&obj.active&&e.isSolid&&rec.y>this.e.y)){canJump=!0;break}return canJump},this.gMove=function(t,i,s=!1,h=!1,n=!1){this.e.idle=0;var a=s?7:u;h?a=d=(d-=.3)>0?d:0:n&&(a=1),rec=N(this.e.hb),rec.x+=t*a,rec.y+=i*a,canMove=!0,amount=a;for(var r=a;r>0;r--){canMove=!0;for(var o=0;o<this.e.colArr.length;o++)if(obj=this.e.colArr[o],null!=obj&&null!=obj.entity){if(e=obj.entity,obj.isTile()&&U(e.hb,rec)&&obj.active&&e.isSolid){canMove=!1;break}}else A=!0;if(canMove)break;amount--,rec.x-=t,rec.y-=i}return amount},this.bloodDrip=function(t){for(let e=1;e<10;e++)this.particles.push(new p(B(1,2),0,t.x+18+B(0,20),t.y+25+B(1,5),0,"bld",!1))},this.bloodSplatter=function(t,e,i){for(let s=0;s<30;s++)this.particles.push(new p(B(1,25),0,e,i,0,"circle",t)),this.particles.push(new p(B(1,8),0,e,i,0,t))}}let et,it,st=window.innerWidth,ht=window.innerHeight,nt=!0,at=0,rt=Date.now(),ot=Date.now(),lt=0,ct=0,ft=new J(0,0),ut=new J(0,0),dt=!1,yt=!1,pt=0,xt=!1,vt=!1,gt="990099",wt="05f2db",mt=!1,bt=1,kt=new Image;kt.src="atlas.png";let Mt=!0,St=new I,Tt=speechSynthesis.getVoices(),Et=!0;n=new AudioContext;let Lt=!1;function startGame(){At.start()}let At={canvas:document.createElement("canvas"),start:function(){this.canvas.width=st,this.canvas.height=ht,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),ctx=this.context,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(It,20),window.addEventListener("keydown",function(t){t.preventDefault(),At.keys=At.keys||[],At.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){At.keys[t.keyCode]="keydown"==t.type,t.keyCode==se&&(vt=!0)}),window.addEventListener("mousedown",function(t){t.preventDefault(),At.keys=At.keys||[],At.keys[t.button]=!0,yt=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),At.keys=At.keys||[],At.keys[t.button]=!1,yt=!1,pt=0,dt=!0,!Lt&&lt>2e3&&(Lt=!0),Ot()}),window.addEventListener("mousemove",function(t){t.preventDefault();let e=At.canvas.getBoundingClientRect();ft.set((t.clientX-e.left)/(e.right-e.left)*st,(t.clientY-e.top)/(e.bottom-e.top)*ht),row=Math.floor(ft.y/this.scaled),col=Math.floor(ft.x/this.scaled),Ot()}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function Ot(){ut.set(ft.x,ft.y)}function It(){if(xt){lt=0,St.hero.e.hp=100,xt=!1,mt=!1,bt=0,Lt=!1,nt=!1,St.genLevel(bt)}Lt&&lt>2e3&&(null!=St.hero&&(St.hero.e.active=!0),nt=!0,null==n&&(n=new AudioContext)),rt=ot,ot=Date.now(),lt+=at=ot-rt,nt?(At.clear(),St.update(at/1e3,lt)):(At.clear(),ctx=At.context,ctx.save(),Pt(ctx,.1,"#"+gt,0,0,st,ht),txt=lt>2e3?"[ CLICK TO START ]":"[ LOADING ]",Dt(ctx,1,"italic 50px Arial","WHITE",txt,380,720),z=lt/1600,Dt(ctx,1,"italic 60px Arial","WHITE","Death Counts",50+40*Math.cos(z),150+20*Math.sin(z)),Dt(ctx,1,"italic 30px Arial","WHITE","Die to live!",50+70*Math.cos(z),230+20*Math.sin(z)))}function Pt(t,e,i,s,h,n,a){t.globalAlpha=e,t.fillStyle=i,t.fillRect(s,h,n,a)}function Dt(t,e,i,s,h,n,a){t.globalAlpha=e,t.font=i,t.fillStyle=s,t.fillText(h,n,a)}function Rt(){return At.keys&&(At.keys[Nt]||At.keys[Zt])}function jt(){return At.keys&&(At.keys[Ft]||At.keys[Xt])}function Ct(){return At.keys&&(At.keys[Ut]||At.keys[Jt])}function Ht(){return At.keys&&(At.keys[zt]||At.keys[Gt])}function Wt(){return At.keys&&At.keys[Qt]}function Kt(){return At.keys&&At.keys[Yt]}function Bt(){return At.keys&&(At.keys[_t]||At.keys[$t])}var Nt=37,Ft=39,Ut=38,zt=40,Jt=87,Zt=65,Gt=83,Xt=68,Yt=77,Vt=0,qt=2,Qt=32,$t=69,_t=49,te=50,ee=51,ie=52,se=82,he=0,ne=1,ae=2,re=3,oe=4,le=5,ce=6,fe=7;