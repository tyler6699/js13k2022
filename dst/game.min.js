var h,n=[];function a(t,e){for(m=h.createBuffer(1,96e3,48e3),gainNode=h.createGain(),b=m.getChannelData(0),i=96e3;i--;)b[i]=getSound(t,i);s=h.createBufferSource(),s.buffer=m,s.connect(gainNode),gainNode.connect(h.destination),gainNode.gain.value=e,s.start()}function o(e){if(t=((t,e)=>(e-t)/e),e>7e4)return null;t(e,7e4);return Math.sin(.001*e*Math.sin(.009*e)+Math.sin(e/100))}function l(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return(128&Math.pow(t,1.055)?1:-1)*Math.pow(e,2)}function u(t){if(t>5e4)return null;var e=(5e4-t)/5e4;return(200&Math.pow(t,.9)?1:-1)*Math.pow(e,3)}function d(t){var e=1e4;if(t>e)return null;var i=(e-t)/e,s=Math.pow(i,2.1);return Math.pow(t,3)&(t<3333.3333333333335?16:99)?s:-s}function g(t){if(t>2e4)return null;var e=(2e4-t)/2e4;return Math.sin(.003*-t*Math.sin(.09*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function p(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return Math.sin(.01*t*Math.sin(.009*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function v(e){if(e>2e3)return null;t=((t,e)=>(e-t)/e);var i=t(e,2e3);return 33&Math.pow(50*e,.7)?i:-i}function w(e){if(t=((t,e)=>(e-t)/e),e>2e4)return null;var i=t(e,2e4);return e*=.04,Math.sin(.03*-e*Math.sin(.09*e+Math.sin(e/200))+Math.sin(e/100))*i}function k(){var t=Y/800,e=Y/800,s=600/q,h=!0;this.ratio=0,console.log("Canvas W: "+Y+" Canvas H: "+q+" newWidthToHeight:"+s),console.log("totalWidth: 800 totalHeight: 600"),console.log("Width Ratio: "+t+" Height Ratio: "+e),console.log("Width:: "+800*t+" Height:: "+600*e),Y>800?(this.ratio=Y/800,console.log("Wider: "+this.ratio)):(this.ratio=Y/800,console.log("High Screen: "+this.ratio)),this.scale=2,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new J(16,16,40*this.scale,100*this.scale,0,T.HERO,this.scale),this.introT=0,this.shake=0,this.shakeTime=0,this.reset=!1,this.wait=2,this.genLevel=function(t){for(this.bkcol=I(),this.levels=[],i=0;i<1;i++){var e=new U(t,Y,q,i,this.scale);e.reset(i,this.scaled),this.levels.push(e)}this.level=this.levels[0],this.hero.e.currentLevel=0},this.genLevel(0);var n=this.levels[this.hero.e.currentLevel].cols;this.surTiles=[-1,1,n-1,n,n+1,-n-1,-n,1-n],this.update=function(t,e){if(h&&(h=!1,ctx.scale(this.ratio,this.ratio)),this.shake=dt?Math.cos(et):0,this.hero.setCurrentTile(this.scaled),C(et),this.level.draw(this.hero,t),nt=!1,this.hero.update(ctx,t),wt.canvas.style.cursor="none",this.introT>0){for(i=0;i<=Y/33;i++)for(j=0;j<=q/33;j++)ctx.save(),ctx.translate(32*i,32*j),col=i%2==0&&j%2==0?"#000":"#FFF",ctx.fillStyle=col,ctx.globalAlpha=.5,ctx.fillRect(this.introT/-2,this.introT/-2,this.introT,this.introT),ctx.restore();this.introT-=48*t}}}getSound=function(t,e){var i;switch(t){case Xt:i=o(e);break;case Yt:i=d(e);break;case qt:i=l(e);break;case Qt:i=u(e);break;case $t:i=g(e);break;case _t:i=p(e);break;case te:i=v(e);break;case ee:i=w(e);break;default:return 1}return i};const T={FLOOR:1,AIR:2,HERO:3,WALL:4,SPIKE:5,TONNE:6,LSPIKE:7,RSPIKE:8,TSPIKE:9,BUTTON:10,PORTAL:11,DOOR:12},M={FOLLOW:0,SIMPLE:1};function S(t,e,i,s,h,n,a,r,o,l){this.entity=new G(t,t,e,i,s,h,"",o,0,0),this.column=a,this.row=r,this.active=!0,this.trigger=l,this.update=function(t){this.entity.update(t)},this.change=function(){this.entity.type>=Object.values(T).length&&(this.entity.type=0),this.entity.setType()},this.isTile=function(){return!0}}function E(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s}function I(){let t="#";for(var e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}var O="Google UK English Female";function L(t){let e=new SpeechSynthesisUtterance;e.text=t,e.voice=speechSynthesis.getVoices().filter(function(t){return t.name==O})[0],speechSynthesis.speak(e)}function A(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function R(t){return new E(t.x,t.y,t.w,t.h)}function H(t,e,i,s,h,n,a,r){return t<h+a&&t+i>h&&e<n+r&&e+s>n}function P(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function W(t,e){this.x=t,this.y=e,this.set=function(t,e){this.x=t,this.y=e}}function C(t){ctx.fillStyle="#FFF";for(let e=2e3;e--;)x=(1e9*Math.sin(e)-t/2e3*(e+1e3)/50)%(wt.canvas.width+9)-9,y=9*e%Y,s=e%5,ctx.fillRect(x,y,s,s)}function K(t){for(i=200;i--;ctx.fillRect(Y/2+i*Math.sin(i)*Z,423+i*Math.cos(9*i)*Z,Z,Z))ctx.fillStyle="rgba(255,255,255,"+(i+.1)+")",Z=2*Math.tan(i/9+t/3)}function N(t,e,i,s,h,n,a,r,o,l,c=0){t.save(),t.globalAlpha=o,t.translate(a,r),t.rotate(c*Math.PI/180),t.drawImage(e,i,s,h,n,h/2,n/2,h*l,n*l),t.restore()}function D(t,e,i,s,h,n,a,r,o){t.save(),t.globalAlpha=o,t.translate(e,i),t.fillStyle=r,t.fillRect(s,h,n,a),t.restore()}function B(){Y=window.innerWidth,q=window.innerHeight;let t=0;t=Y/q>4/3?(Y=q*(4/3))/1216:(q=Y/(4/3))/832,xt.scale=t*scale.scale}function F(t){var e=A(0,360)*Math.PI/180,i=A(50,180),s=[-1,1][A(0,1)]*i;return{x:t.x+s*Math.cos(e),y:t.y+s*Math.sin(e)}}function U(t,e,i,s,h,n=!1){ft=t,this.tiles=[],this.triggers=[],this.breakTiles=[],this.mvTiles=[],this.active=!1,this.roomNo=s;function a(t,e,i,s){return 1==e||e==i-2||1==t&&1==e||1==t&&e==i-2||1==t&&e>1&&e<i-2||t==s-2&&e==i-2||t==s-2&&1==e||t==s-2&&e>1&&e<i-2}this.cols=24,this.draw=function(t,e){this.tiles.forEach(t=>t.update(e));for(let e=0;e<this.triggers.length;e++){let i=this.triggers[e];if(!i.trigger)return;i.entity.x,i.entity.hWidth;if(i.entity.type==T.TONNE){let e=t.e.x,s=t.e.x+t.e.width*h,n=i.entity.x,a=i.entity.x+i.entity.width*h;(e>n&&e<a||s>n&&s<a)&&t.e.y-t.e.height>i.entity.y&&(i.entity.y+=30),P(t.e.hb,i.entity.hb)&&(t.kill(),i.trigger=!1)}}},this.reset=function(t,e){this.tiles=[],this.dTiles=[];let i=!1;for(r=0;r<13;r++)for(c=0;c<this.cols;c++){var s;i=!1,ts=16*h,xx=c*ts,yy=r*ts;var n=T.AIR;0==r||0==c||12==r||c==this.cols?n=T.AIR:10==r&&5==c?n=T.BLOCK:a(r,c,this.cols,13)&&(n=T.BLOCK),10==r&&15==c&&(n=T.SPIKE),3==r&&5==c&&(n=T.TONNE),10==r&&12==c&&(n=T.SPIKE),6==r&&15==c&&(n=T.LSPIKE),6==r&&8==c&&(n=T.RSPIKE),6==r&&10==c&&(n=T.TSPIKE),10==r&&4==c&&(n=T.BUTTON),10==r&&16==c&&(n=T.PORTAL),9==r&&5==c&&(n=T.DOOR),n==T.TONNE&&(i=!0),s=new S(16,xx,yy,0,n,!1,c,r,h,i),this.tiles.push(s),1==s.trigger&&this.triggers.push(s)}},this.addAir=function(t){this.tiles[t].entity.setT(T.AIR)},this.addWall=function(t){this.tiles[t].entity.setT(T.WALL)}}function G(t,e,i,h,n,a,r,o,l=!1,c=0){this.scale=o,this.type=a,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWScaled=t/-2*o,this.mhHScaled=e/-2*o,this.hWidth=t/2,this.hHeight=e/2,this.angle=n,this.x=i,this.y=h,this.active=!0,this.colour=r,this.image=yt,this.animated=!1,this.alpha=1,this.currentTile=0,this.colArr=[],this.isSolid=!1,this.isButton=l,this.time=0,this.maxHP=c,this.hp=this.maxHP,this.breaks=!1,this.flip=!1,this.idle=0,this.pressed=!1,this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new E(0,0,0,0),this.sensor=new E(0,0,0,0),this.isButton&&(this.hb.w=2*this.width,this.hb.h=2*this.height)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.scale/2,this.hb.y=this.y+this.scale/2,this.hb.w=this.width*this.scale-this.scale,this.hb.h=this.height*this.scale-this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.update=function(i){this.idle+=i,this.updateHitbox(),this.active&&!this.isFloor()&&(ctx.save(),ctx.translate(this.x,this.y),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,t=this.width,e=this.height,xt.shakeTime>0&&(xt.shakeTime-=i/1e3,ctx.translate(xt.shake,xt.shake)),null==this.image?(ctx.fillStyle=this.colour,ctx.fillRect(.5*mhw*s,.5*mhh*s,.5*t*s,.5*e*s)):(this.flip?(ctx.scale(-1,1),ctx.translate(-t*s-t,0)):ctx.scale(1,1),f=0,z=0,this.angle>0&&(ctx.translate(24,24),ctx.rotate(this.angle*Math.PI/180),ctx.translate(-24,-24)),ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh+f,t*s,e*s)),ctx.restore())},this.isHero=function(){return this.type==T.HERO},this.isTile=function(){return!1},this.setT=function(t){this.type=t,this.setType()},this.isFloor=function(){return this.type==T.FLOOR},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.isSolid=!1,this.type){case T.HERO:this.isSolid=!0,this.sx=0,this.sy=0;break;case T.WALL:this.sy=16;break;case T.BLOCK:this.isSolid=!0,this.sx=16;break;case T.SPIKE:this.sx=48;break;case T.LSPIKE:this.sx=48,this.angle=270;break;case T.RSPIKE:this.sx=48,this.angle=90;break;case T.TSPIKE:this.sx=48,this.angle=180;break;case T.TONNE:this.sx=48,this.sy=16;break;case T.BUTTON:this.sx=64;break;case T.FLOOR:this.sx=32,this.sy=32,this.alpha=.9;break;case T.PORTAL:this.sx=64,this.sy=16,this.alpha=.9;break;case T.AIR:this.sx=144;break;case T.DOOR:this.isSolid=!0,this.sx=32}},this.setType()}function J(t,i,s,h,n,r,o){this.e=new G(t,i,s,h,n,r,"",o,!1,100),this.e.hp=100,this.hereos=[],this.active=!0,this.hp=3,this.particles=[];let l=null,c=!1,u=0,f=0,y=0,d=.1,x=Ht,g={x:this.e.x,y:this.e.y},p=[],v=0,w=.1,b=0;this.update=function(t,e){if(this.time+=e,(Math.abs(g.x-this.e.x)>20||Math.abs(g.y-this.e.y)>20)&&(!function(t,e,i){i.length>10&&i.splice(0,1);i.push({x:t,y:e,d:x})}(this.e.x,this.e.y,p),g={x:this.e.x,y:this.e.y}),this.active&&(Mt()||St()?(this.e.angle+=20,b+=e,u=u>6?6:u+=.5):(u=u>0?u-=.5:0,this.e.angle=0),(Mt()||u>0&&x==Rt)&&(x=Rt,this.e.x-=this.gMove(-1,0),this.e.flip=!0),(St()||u>0&&x==Ht)&&(x=Ht,this.e.x+=this.gMove(1,0),this.e.flip=!1)),y<=0&&this.grounded()?c=!1:y>0&&(this.e.y-=this.gMove(0,-1,!1,!0),y-=e),this.canFall&&d>=.1?this.e.y+=this.gMove(0,1,!0,!1):this.grounded()||(d+=e),this.grounded()&&0!=d&&!c&&(d=0),null!=l){let t=l.entity.type;t==T.SPIKE||t==T.LSPIKE||t==T.RSPIKE||t==T.TSPIKE?this.kill():t!=T.BUTTON||l.entity.pressed?t==T.PORTAL&&console.log("DONE"):(l.entity.pressed=!0,l.entity.sx=80,a(Yt,.8))}(Et()||Ot())&&this.jump(),this.hereos.forEach((e,i)=>(function t(e,i,s,h){if(i.constructor===Array&&v>0&&s==h)for(let s=0;s<=i.length-1;s++)t(e,i[s],s,i.length-1);else v>0&&N(e,this.e.image,0,16,this.e.width,this.e.height,i.x,i.y,s/h+.05,o);if(i.constructor===Array){let t=i[i.length-1];null!=t&&N(e,this.e.image,0,16,this.e.width,this.e.height,t.x,t.y,.7,o)}})(t,e,i,this.hereos.length-1));for(let e=1;e<=this.hp;e++)N(t,this.e.image,0,0,this.e.width,this.e.height,2*this.e.width*e,2*this.e.height,1,o);for(let i=0;i<=this.particles.length-1;i++)this.particles[i].update(t,e);if(this.e.update(e),At()&&this.hereos.length>0)if(v=.1,w<=0){w=.1;let t=this.hereos[this.hereos.length-1],e=1==t.length?t[0]:t[t.length-2];rec=new E(e.x,e.y,this.e.hb.w,this.e.hb.h),P(this.e.hb,rec)&&this.active||(this.hereos[this.hereos.length-1].pop(),0==this.hereos[this.hereos.length-1].length&&(this.hereos.splice(this.hereos.length-1,1),this.hp++,this.active=!0))}else w-=e;v>0&&(v-=e),b>.3&&this.addDust(),this.particles=this.particles.filter(function(t){return 0==t.remove})},this.kill=function(){this.bloodSplatter(),a(_t,1),this.hp>0&&(this.hp--,this.hereos.push(p),p=[],this.e.x=40*o,this.e.y=100*o,0==this.hp&&(this.active=!1))},this.setCurrentTile=function(t){heroRow=Math.floor((this.e.y-this.e.mhHScaled)/t),heroCol=Math.floor((this.e.x-this.e.mhWScaled)/t),heroTileIndex=heroCol+xt.levels[this.e.currentLevel].cols*heroRow,null!=l&&(this.prevTile=l),l=xt.level.tiles[heroTileIndex],this.e.x==g.x&&this.e.y==g.y||(this.e.colArr=[],xt.surTiles.forEach(t=>this.e.colArr.push(xt.level.tiles[heroTileIndex+t])),this.hereos.forEach(t=>(function(t,e){let i=t[t.length-1];if(null!=i){let t=new S(16,i.x,i.y,0,T.BLOCK,!1,0,0,o,!1);t.entity.updateHitbox(),e.push(t)}})(t,this.e.colArr)))},this.addDust=function(){b=0},this.canFall=function(){return this.gMove(0,1,!1,!1,!0)>0},this.jump=function(){!c&&d<=.1&&this.active&&(d=.1,c=!0,y=.5,f=14,a(qt,.2))},this.grounded=function(){rec=R(this.e.hb),rec.y+=2,canJump=!1;for(var t=0;t<this.e.colArr.length;t++)if(obj=this.e.colArr[t],e=obj.entity,obj.isTile()&&P(e.hb,rec)&&obj.active&&e.isSolid&&rec.y>this.e.y){canJump=!0;break}return canJump},this.gMove=function(t,i,s=!1,h=!1,n=!1){this.e.idle=0;var a=s?7:u;h?a=f=(f-=.3)>0?f:0:n&&(a=1),rec=R(this.e.hb),rec.x+=t*a,rec.y+=i*a,canMove=!0,amount=a;for(var r=a;r>0;r--){canMove=!0;for(var o=0;o<this.e.colArr.length;o++)if(obj=this.e.colArr[o],e=obj.entity,obj.isTile()){if(P(e.hb,rec)&&obj.active&&e.isSolid){canMove=!1;break}}else if(obj.active&&obj.isSolid&&P(obj.hb,rec)){canMove=!1;break}if(canMove)break;amount--,rec.x-=t,rec.y-=i}return amount},this.bloodSplatter=function(){for(let t=0;t<30;t++){let t=new particle(A(1,25),0,this.e.x-this.e.mhWScaled,this.e.y-this.e.mhHScaled,0,"circle");this.particles.push(t),t=new particle(A(1,8),0,this.e.x-this.e.mhWScaled,this.e.y-this.e.mhHScaled,0,"circle"),this.particles.push(t)}}}let V,X,Y=window.innerWidth,q=window.innerHeight,Q=!0,$=0,_=Date.now(),tt=Date.now(),et=0,it=0,st=new W(0,0),ht=new W(0,0),nt=!1,at=!1,rt=0,ot=!1,lt="990099",ct="05f2db",ut=!1,ft=1,yt=new Image;yt.src="atlas.png";let dt=!0,xt=new k,gt=speechSynthesis.getVoices(),pt=!0;h=new AudioContext;let vt=!1;function startGame(){wt.start()}let wt={canvas:document.createElement("canvas"),start:function(){this.canvas.width=Y,this.canvas.height=q,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),ctx=this.context,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(kt,20),window.addEventListener("keydown",function(t){t.preventDefault(),wt.keys=wt.keys||[],wt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){wt.keys[t.keyCode]="keydown"==t.type,t.keyCode==Ut&&(dt=!dt),t.keyCode==Zt&&(xt.bkcol=I()),t.keyCode==Vt&&(ot=!0)}),window.addEventListener("mousedown",function(t){t.preventDefault(),wt.keys=wt.keys||[],wt.keys[t.button]=!0,at=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),wt.keys=wt.keys||[],wt.keys[t.button]=!1,at=!1,rt=0,nt=!0,!vt&&et>2e3&&(vt=!0),bt()}),window.addEventListener("mousemove",function(t){t.preventDefault();let e=wt.canvas.getBoundingClientRect();st.set((t.clientX-e.left)/(e.right-e.left)*Y,(t.clientY-e.top)/(e.bottom-e.top)*q),row=Math.floor(st.y/this.scaled),col=Math.floor(st.x/this.scaled),bt()}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function bt(){ht.set(st.x,st.y)}function kt(){if(ot){et=0,xt.hero.e.hp=100,ot=!1,ut=!1,ft=0,vt=!1,Q=!1,xt.genLevel(ft)}vt&&et>2e3&&(null!=xt.hero&&(xt.hero.e.active=!0),Q=!0,null==h&&(h=new AudioContext)),_=tt,tt=Date.now(),et+=$=tt-_,Q?(wt.clear(),xt.update($/1e3,et)):(wt.clear(),ctx=wt.context,ctx.save(),mt(ctx,.1,"#"+lt,0,0,Y,q),txt=et>2e3?"[ CLICK TO START ]":"[ LOADING ]",Tt(ctx,1,"italic 50px Arial","WHITE",txt,380,720),z=et/1600,Tt(ctx,1,"italic 60px Arial","WHITE","Death Counts",50+40*Math.cos(z),150+20*Math.sin(z)),Tt(ctx,1,"italic 30px Arial","WHITE","Die to live!",50+70*Math.cos(z),230+20*Math.sin(z)))}function mt(t,e,i,s,h,n,a){t.globalAlpha=e,t.fillStyle=i,t.fillRect(s,h,n,a)}function Tt(t,e,i,s,h,n,a){t.globalAlpha=e,t.font=i,t.fillStyle=s,t.fillText(h,n,a)}function Mt(){return wt.keys&&(wt.keys[Rt]||wt.keys[Kt])}function St(){return wt.keys&&(wt.keys[Ht]||wt.keys[jt])}function Et(){return wt.keys&&(wt.keys[Pt]||wt.keys[Ct])}function It(){return wt.keys&&(wt.keys[Wt]||wt.keys[Nt])}function Ot(){return wt.keys&&wt.keys[zt]}function Lt(){return wt.keys&&wt.keys[Dt]}function At(){return wt.keys&&wt.keys[Ut]}var Rt=37,Ht=39,Pt=38,Wt=40,Ct=87,Kt=65,Nt=83,jt=68,Dt=77,Bt=0,Ft=2,zt=32,Ut=49,Zt=50,Gt=51,Jt=52,Vt=82,Xt=0,Yt=1,qt=2,Qt=3,$t=4,_t=5,te=6,ee=7;