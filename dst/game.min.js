var n,a=[];function o(t,e){for(m=n.createBuffer(1,96e3,48e3),gainNode=n.createGain(),b=m.getChannelData(0),i=96e3;i--;)b[i]=getSound(t,i);s=n.createBufferSource(),s.buffer=m,s.connect(gainNode),gainNode.connect(n.destination),gainNode.gain.value=e,s.start()}function l(e){if(t=((t,e)=>(e-t)/e),e>7e4)return null;t(e,7e4);return Math.sin(.001*e*Math.sin(.009*e)+Math.sin(e/100))}function u(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return(128&Math.pow(t,1.055)?1:-1)*Math.pow(e,2)}function d(t){if(t>5e4)return null;var e=(5e4-t)/5e4;return(200&Math.pow(t,.9)?1:-1)*Math.pow(e,3)}function v(t){var e=1e4;if(t>e)return null;var i=(e-t)/e,s=Math.pow(i,2.1);return Math.pow(t,3)&(t<3333.3333333333335?16:99)?s:-s}function p(t){if(t>2e4)return null;var e=(2e4-t)/2e4;return Math.sin(.003*-t*Math.sin(.09*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function g(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return Math.sin(.01*t*Math.sin(.009*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function k(e){if(e>2e3)return null;t=((t,e)=>(e-t)/e);var i=t(e,2e3);return 33&Math.pow(50*e,.7)?i:-i}function M(e){if(t=((t,e)=>(e-t)/e),e>2e4)return null;var i=t(e,2e4);return e*=.04,Math.sin(.03*-e*Math.sin(.09*e+Math.sin(e/200))+Math.sin(e/100))*i}function T(){var t=0;t=J/Q>4/3?(J=Q*(4/3))/1216:(Q=J/(4/3))/832,this.scale=3*t,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new X(16,16,J/2,Q/2,0,S.HERO,this.scale),this.introT=0,this.shake=0,this.shakeTime=0,this.reset=!1,this.wait=2,this.genLevel=function(t){for(this.bkcol=H(),this.levels=[],i=0;i<1;i++){var e=new U(t,J,Q,i,this.scale);e.reset(i,this.scaled),this.levels.push(e)}this.level=this.levels[0],this.hero.e.currentLevel=0},this.genLevel(0);var e=this.levels[this.hero.e.currentLevel].cols;this.surTiles=[-1,1,e-1,e,e+1,-e-1,-e,1-e],this.update=function(t,e){this.shake=vt?Math.cos(it):0,St()&&(this.hero.e.x-=this.hero.gMove(-1,0),this.hero.e.flip=!0),At()&&(this.hero.e.x+=this.hero.gMove(1,0),this.hero.e.flip=!1),Lt()&&(this.hero.e.y-=this.hero.gMove(0,-1)),Rt()&&(this.hero.e.y+=this.hero.gMove(0,1)),this.hero.setCurrentTile(this.scaled),B(it),this.level.draw(this.hero.e,t),at=!1,this.hero.update(t),gt.canvas.style.cursor="none";let s=ht.x,n=ht.y;if(ctx.fillStyle="BLACK",ctx.globalAlpha=.4,w=8,h=40,ctx.fillRect(s-4,n-20,w,h),ctx.fillRect(s-20,n-4,h,w),this.introT>0){for(i=0;i<=J/33;i++)for(j=0;j<=Q/33;j++)ctx.save(),ctx.translate(32*i,32*j),col=i%2==0&&j%2==0?"#000":"#FFF",ctx.fillStyle=col,ctx.globalAlpha=.5,ctx.fillRect(this.introT/-2,this.introT/-2,this.introT,this.introT),ctx.restore();this.introT-=48*t}}}getSound=function(t,e){var i;switch(t){case Yt:i=l(e);break;case qt:i=v(e);break;case Jt:i=u(e);break;case Qt:i=d(e);break;case $t:i=p(e);break;case _t:i=g(e);break;case te:i=k(e);break;case ee:i=M(e);break;default:return 1}return i};const S={FLOOR:1,AIR:2,HERO:3,WALL:8},A={FOLLOW:0,SIMPLE:1};function L(t,e,i,s,h,n,a,o,r){this.entity=new V(t,t,e,i,s,h,"",r,0,0),this.column=a,this.row=o,this.active=!0,this.update=function(t){this.entity.update(t)},this.change=function(){this.entity.type>=Object.values(S).length&&(this.entity.type=0),this.entity.setType()},this.isTile=function(){return!0}}function R(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s}function H(){for(var t="#",e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}var E="Google UK English Female";function I(t){var e=new SpeechSynthesisUtterance;e.text=t,e.voice=speechSynthesis.getVoices().filter(function(t){return t.name==E})[0],speechSynthesis.speak(e)}function C(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function O(t){return new R(t.x,t.y,t.w,t.h)}function W(t,e,i,s,h,n,a,o){return t<h+a&&t+i>h&&e<n+o&&e+s>n}function F(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function D(t,e){this.x=t,this.y=e,this.set=function(t,e){this.x=t,this.y=e}}function B(t){ctx.fillStyle="#FFF";for(let e=2e3;e--;)x=(1e9*Math.sin(e)-t/2e3*(e+1e3)/50)%(gt.canvas.width+9)-9,y=9*e%J,s=e%5,ctx.fillRect(x,y,s,s)}function N(t){for(i=200;i--;ctx.fillRect(J/2+i*Math.sin(i)*Z,423+i*Math.cos(9*i)*Z,Z,Z))ctx.fillStyle="rgba(255,255,255,"+(i+.1)+")",Z=2**Math.tan(i/9+t/3)}function K(t,e,i,s,h,n,a,o,r,c){t.save(),t.globalAlpha=r,t.translate(a,o),t.drawImage(e,i,s,h,n,h/2,n/2,h*c,n*c),t.restore()}function G(t,e,i,s,h,n,a,o,r){t.save(),t.globalAlpha=r,t.translate(e,i),t.fillStyle=o,t.fillRect(s,h,n,a),t.restore()}function P(){J=window.innerWidth,Q=window.innerHeight;var t=0;t=J/Q>4/3?(J=Q*(4/3))/1216:(Q=J/(4/3))/832,xt.scale=t*scale.scale}function U(t,e,i,s,h,n=!1){dt=t,this.tiles=[],this.breakTiles=[],this.mvTiles=[],this.active=!1,this.roomNo=s;function a(t,e,i,s){return 1==e||e==i-2||1==t&&1==e||1==t&&e==i-2||1==t&&e>1&&e<i-2||t==s-2&&e==i-2||t==s-2&&1==e||t==s-2&&e>1&&e<i-2}this.rows=13,this.cols=24,this.draw=function(t,e){this.tiles.forEach(t=>t.update(e))},this.reset=function(t,e){for(this.tiles=[],this.dTiles=[],r=0;r<this.rows;r++)for(c=0;c<this.cols;c++){var i;ts=16*h,xx=c*ts,yy=r*ts;var s=S.AIR;0==r||0==c||12==r||c==this.cols?s=S.AIR:a(r,c,this.cols,this.rows)&&(s=S.BLOCK),i=new L(16,xx,yy,0,s,!1,c,r,h),this.tiles.push(i)}},this.addAir=function(t){this.tiles[t].entity.setT(S.AIR)},this.addWall=function(t){this.tiles[t].entity.setT(S.WALL)}}function V(t,e,i,h,n,a,o,r,c=!1,l=0){this.scale=r,this.type=a,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWScaled=t/-2*r,this.mhHScaled=e/-2*r,this.hWidth=t/2,this.hHeight=e/2,this.yOffset=0,this.angle=n,this.x=i,this.y=h,this.active=!0,this.colour=o,this.image=yt,this.animated=!1,this.alpha=1,this.currentTile=0,this.colArr=[],this.isSolid=!1,this.isButton=c,this.time=0,this.maxHP=l,this.hp=this.maxHP,this.breaks=!1,this.flip=!1,this.idle=0,this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new R(0,0,0,0),this.sensor=new R(0,0,0,0),this.isButton&&(this.hb.w=2*this.width,this.hb.h=2*this.height)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.scale/2,this.hb.y=this.y+this.scale/2,this.hb.w=this.width*this.scale-this.scale,this.hb.h=this.height*this.scale-this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.update=function(i){this.idle+=i,this.updateHitbox(),this.active&&!this.isFloor()&&(ctx.save(),ctx.translate(this.x,this.y),ctx.rotate(this.angle),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,t=this.width,e=this.height,xt.shakeTime>0&&(xt.shakeTime-=i/1e3,ctx.translate(xt.shake,xt.shake)),null==this.image?(ctx.fillStyle=this.colour,ctx.fillRect(.5*mhw*s,.5*mhh*s,.5*t*s,.5*e*s)):(this.flip?(ctx.scale(-1,1),ctx.translate(-t*s-t,0)):ctx.scale(1,1),f=0,z=0,ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh+f,t*s,e*s)),ctx.restore())},this.isHero=function(){return this.type==S.HERO},this.isTile=function(){return!1},this.setT=function(t){this.type=t,this.setType()},this.isFloor=function(){return this.type==S.FLOOR},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.isSolid=!1,this.type){case S.HERO:this.isSolid=!0,this.sx=96,this.sy=16;break;case S.WALL:this.sy=16;break;case S.BLOCK:this.isSolid=!0,this.sx=16;break;case S.FLOOR:this.sx=32,this.sy=32,this.alpha=.9;break;case S.AIR:this.sx=144}},this.setType()}function X(t,i,s,h,n,a,o){this.e=new V(t,i,s,h,n,a,"",o,!1,100),this.e.hp=100,this.speed=5,this.currentTile=null,this.update=function(t){this.time+=t,this.e.update(t)},this.setCurrentTile=function(t){heroRow=Math.floor((this.e.y-this.e.mhHScaled)/t),heroCol=Math.floor((this.e.x-this.e.mhWScaled)/t),heroTileIndex=heroCol+xt.levels[this.e.currentLevel].cols*heroRow,null!=this.currentTile&&(this.prevTile=this.currentTile),this.currentTile=xt.level.tiles[heroTileIndex],this.currentTile!=this.prevTile&&(this.e.colArr=[],xt.surTiles.forEach(t=>this.e.colArr.push(xt.level.tiles[heroTileIndex+t])))},this.gMove=function(t,i){this.e.idle=0,rec=O(this.e.hb),rec.x+=t*this.speed,rec.y+=i*this.speed,amount=this.speed,stop=!1,canMove=!0;for(var s=this.speed;s>0;s--){canMove=!0;for(var h=0;h<this.e.colArr.length;h++)if(obj=this.e.colArr[h],e=obj.entity,obj.isTile()){if(!stop&&F(e.hb,rec)&&obj.active&&e.isSolid){canMove=!1;break}}else if(!stop&&obj.active&&obj.isSolid&&F(obj.hb,rec)){canMove=!1;break}if(canMove||stop)break;amount--,rec.x-=t,rec.y-=i}return amount}}var Y,q,J=window.innerWidth,Q=window.innerHeight,$=!1,_=0,tt=Date.now(),et=Date.now(),it=0,st=0,ht=new D(0,0),nt=new D(0,0),at=!1,ot=!1,rt=0,ct=!1,lt="990099",ut="05f2db",ft=!1,dt=1,yt=new Image;yt.src="atlas.png";var vt=!0,xt=new T,wt=speechSynthesis.getVoices(),pt=!0,bt=!1;function startGame(){gt.start()}var gt={canvas:document.createElement("canvas"),start:function(){this.canvas.width=J,this.canvas.height=Q,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),ctx=this.context,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(mt,20),window.addEventListener("keydown",function(t){t.preventDefault(),gt.keys=gt.keys||[],gt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){gt.keys[t.keyCode]="keydown"==t.type,t.keyCode==Gt&&(vt=!vt),t.keyCode==Pt&&(xt.bkcol=H()),t.keyCode==Xt&&(ct=!0)}),window.addEventListener("mousedown",function(t){t.preventDefault(),gt.keys=gt.keys||[],gt.keys[t.button]=!0,ot=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),gt.keys=gt.keys||[],gt.keys[t.button]=!1,ot=!1,rt=0,at=!0,!bt&&it>2e3&&(bt=!0),kt()}),window.addEventListener("mousemove",function(t){t.preventDefault();var e=gt.canvas.getBoundingClientRect();ht.set((t.clientX-e.left)/(e.right-e.left)*J,(t.clientY-e.top)/(e.bottom-e.top)*Q),row=Math.floor(ht.y/this.scaled),col=Math.floor(ht.x/this.scaled),kt()}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function kt(){nt.set(ht.x,ht.y)}function mt(){ct&&(it=0,xt.hero.e.hp=100,ct=!1,ft=!1,dt=0,bt=!1,$=!1,xt.genLevel(dt));bt&&it>2e3&&(null!=xt.hero&&(xt.hero.e.active=!0),$=!0,null==n&&(n=new AudioContext)),tt=et,et=Date.now(),it+=_=et-tt,$?(gt.clear(),xt.update(_/1e3,it)):(gt.clear(),ctx=gt.context,ctx.save(),Mt(ctx,.1,"#"+lt,0,0,J,Q),txt=it>2e3?"[ CLICK TO START ]":"[ LOADING ]",Tt(ctx,1,"italic 50px Arial","WHITE",txt,380,720),z=it/1600,Tt(ctx,1,"italic 60px Arial","WHITE","Death Counts",50+40*Math.cos(z),150+20*Math.sin(z)),Tt(ctx,1,"italic 30px Arial","WHITE","Die to live!",50+70*Math.cos(z),230+20*Math.sin(z)))}function Mt(t,e,i,s,h,n,a){t.globalAlpha=e,t.fillStyle=i,t.fillRect(s,h,n,a)}function Tt(t,e,i,s,h,n,a){t.globalAlpha=e,t.font=i,t.fillStyle=s,t.fillText(h,n,a)}function St(){return gt.keys&&(gt.keys[It]||gt.keys[jt])}function At(){return gt.keys&&(gt.keys[Ct]||gt.keys[Bt])}function Lt(){return gt.keys&&(gt.keys[Ot]||gt.keys[Ft])}function Rt(){return gt.keys&&(gt.keys[Wt]||gt.keys[Dt])}function Ht(){return gt.keys&&gt.keys[Zt]}function Et(){return gt.keys&&gt.keys[zt]}var It=37,Ct=39,Ot=38,Wt=40,Ft=87,jt=65,Dt=83,Bt=68,zt=77,Nt=0,Kt=2,Zt=32,Gt=49,Pt=50,Ut=51,Vt=52,Xt=82,Yt=0,qt=1,Jt=2,Qt=3,$t=4,_t=5,te=6,ee=7;
