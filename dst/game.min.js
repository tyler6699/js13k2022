var h,n=!1,a=!1,o={songData:[{i:[2,96,128,0,2,8,164,0,0,5,12,44,43,0,0,0,0,69,3,1,1,26,116,0,32,0,6,76,6],p:[1,3,1,4,5,6,7,8],c:[{n:[147,,,,,,,,150,,,,,,,,149,,,,,,150,149,147,,,,,,145],f:[]},{n:[],f:[]},{n:[147,,,,,,145,147,149,,,,,,147,145,147],f:[]},{n:[147,,,,,,145,147,149,,,,,,150,152,154,,,,,,,,153],f:[]},{n:[154,,,,,,,,157,,,,,,156,157,159,,,,,,,,154,,,,,,152],f:[]},{n:[154,,,,,,,,157,,,,,,156,157,159,,,,,,,,,,,,,,161],f:[]},{n:[162,,,,,,,,,,,,,,161,162,164,,,,,,,,,,,,,,161,164],f:[]},{n:[166,,,,,,,,,,,,,,,173,173],f:[]}]},{i:[3,61,128,0,3,63,128,0,0,9,17,40,72,0,0,0,1,178,7,0,2,255,15,0,32,83,8,84,8],p:[11,12,11,14,13,13,15,16],c:[{n:[],f:[]},{n:[147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147,,,,147],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,135,,,,,,,,,,,,,,,,138,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,144],f:[]},{n:[131,,,,,,,,133,,,,,,,,135,,,,,,,,,,,,,,,,135,,,,,,,,137,,,,,,,,139,,,,,,,,,,,,,,,,138,,,,,,,,140,,,,,,,,142],f:[]},{n:[142,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,147,,,,,,,,,,,,,,,,149,,,,,,,,,,,,,,,,151],f:[]},{n:[131,,,,,,,,133,,,,,,,,138,,,,,,,,137,,,,,,,,135,,,,,,,,137,,,,,,,,142,,,,,,,,141,,,,,,,,138,,,,,,,,140,,,,,,,,145,,,,,,,,144],f:[]},{n:[138,,,,,,,,,,,,,,,,140,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,144,,,,,,,,,,,,,,,,145,,,,,,,,,,,,,,,,147],f:[]},{n:[142,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,147,,,,,,,,,,,,,,,,146,,,,,,,,,,,,,,,,149,,,,,,,,,,,,,,,,149],f:[]}]},{i:[1,0,128,0,1,0,128,9,0,37,13,5,20,0,0,0,0,0,0,0,2,255,0,0,32,47,3,0,1],p:[17,17,17,17,17,17,17,17],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147,147,,147,147],f:[]}]},{i:[0,99,116,79,0,53,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[18,18,18,18,18,18,18,18],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,135,,,,137,,,,135,,,,135,,,,135,,,,135,,,,135],f:[]}]},{i:[2,83,128,0,3,182,128,0,0,0,0,6,29,0,0,0,0,0,0,0,3,5,184,119,244,147,6,0,0],p:[19,20,19,21,22,22,23,24],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[111,,111,111,111,,111,111,111,,111,111,111,,111,,104,,104,104,104,,104,104,104,,104,104,104,,106],f:[]},{n:[107,,107,107,107,,107,107,109,,109,109,109,,109,109,111,,111,111,111,,111,111,111,,111,111,111,,111],f:[]},{n:[107,,107,107,107,,107,107,109,,109,109,109,,109,109,114,,114,114,114,,114,114,113,,113,113,113,114,115,116],f:[]},{n:[118,,118,118,118,,118,118,118,,118,118,118,,118,,111,,111,111,111,,111,111,111,,111,111,111,113,114,116],f:[]},{n:[114,,114,114,114,,114,114,114,,114,114,114,,114,114,116,,116,116,116,,116,116,116,,116,116,116,,116],f:[]},{n:[118,,118,118,118,,118,118,118,,118,118,118,,113,,118,,118,118,118,,118,118,118,,118,118,118,116,114,113],f:[]}]}],rowLen:4562,patternLen:32,endPattern:7,numChannels:5},l=function(){var t,e,i,s,h,n=function(t){return Math.sin(6.283184*t)},a=function(t){return.003959503758*2**((t-128)/12)},o=function(t,e,i){var s,h,n,o,l,c,f=r[t.i[0]],u=t.i[1],y=t.i[3]/32,d=r[t.i[4]],x=t.i[5],p=t.i[8]/32,v=t.i[9],m=t.i[10]*t.i[10]*4,w=t.i[11]*t.i[11]*4,b=t.i[12]*t.i[12]*4,g=1/b,M=-t.i[13]/16,k=t.i[14],S=i*2**(2-t.i[15]),T=new Int32Array(m+w+b),E=0,R=0;for(s=0,h=0;s<m+w+b;s++,h++)h>=0&&(h-=S,l=a(e+(15&(k=k>>8|(255&k)<<4))+t.i[2]-128),c=a(e+(15&k)+t.i[6]-128)*(1+8e-4*t.i[7])),n=1,s<m?n=s/m:s>=m+w&&(n=(1-(n=(s-m-w)*g))*3**(M*n)),o=f(E+=l*n**y)*u,o+=d(R+=c*n**p)*x,v&&(o+=(2*Math.random()-1)*v),T[s]=80*o*n|0;return T},r=[n,function(t){return t%1<.5?1:-1},function(t){return t%1*2-1},function(t){var e=t%1*4;return e<2?e-1:3-e}];this.init=function(n){t=n,e=n.endPattern,i=0,s=n.rowLen*n.patternLen*(e+1)*2,h=new Int32Array(s)},this.generate=function(){var a,l,c,f,u,y,d,x,p,v,m,w,b,g,M=new Int32Array(s),k=t.songData[i],S=t.rowLen,T=t.patternLen,E=0,R=0,A=!1,C=[];for(c=0;c<=e;++c)for(d=k.p[c],f=0;f<T;++f){var D=d?k.c[d-1].f[f]:0;D&&(k.i[D-1]=k.c[d-1].f[f+T]||0,D<17&&(C=[]));var H=r[k.i[16]],I=k.i[17]/512,L=2**(k.i[18]-9)/S,W=k.i[19],P=k.i[20],j=43.23529*k.i[21]*3.141592/44100,z=1-k.i[22]/255,B=1e-5*k.i[23],N=k.i[24]/32,O=k.i[25]/512,Y=6.283184*2**(k.i[26]-9)/S,G=k.i[27]/255,F=k.i[28]*S&-2;for(m=(c*T+f)*S,u=0;u<4;++u)if(y=d?k.c[d-1].n[f+u*T]:0){C[y]||(C[y]=o(k,y,S));var K=C[y];for(l=0,a=2*m;l<K.length;l++,a+=2)M[a]+=K[l]}for(l=0;l<S;l++)(v=M[x=2*(m+l)])||A?(w=j,W&&(w*=H(L*x)*I+.5),R+=(w=1.5*Math.sin(w))*(b=z*(v-R)-(E+=w*R)),v=3==P?R:1==P?b:E,B&&(v=(v*=B)<1?v>-1?n(.25*v):-1:1,v/=B),A=(v*=N)*v>1e-5,g=v*(1-(p=Math.sin(Y*x)*O+.5)),v*=p):g=0,x>=F&&(g+=M[x-F+1]*G,v+=M[x-F]*G),M[x]=0|g,M[x+1]=0|v,h[x]+=0|g,h[x+1]+=0|v}return++i/t.numChannels},this.createAudioBuffer=function(t){for(var e=t.createBuffer(2,s/2,44100),i=0;i<2;i++)for(var n=e.getChannelData(i),a=i;a<s;a+=2)n[a>>1]=h[a]/65536;return e},this.createWave=function(){var t=44+2*s-8,e=t-36,i=new Uint8Array(44+2*s);i.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(var n=0,a=44;n<s;++n){var o=h[n];o=o<-32767?-32767:o>32767?32767:o,i[a++]=255&o,i[a++]=o>>8&255}return i},this.getData=function(t,e){for(var i=2*Math.floor(44100*t),s=new Array(e),n=0;n<2*e;n+=1){var a=i+n;s[n]=t>0&&a<h.length?h[a]/32768:0}return s}},u;function y(){var t=new l;t.init(o),setInterval(function(){if(!n&&(n=t.generate()>=1)){var e=t.createWave();(h=document.createElement("audio")).src=URL.createObjectURL(new Blob([e],{type:"audio/wav"})),a=!0}},0)}function d(t,e,i,s,h,n,a,o=It){this.time=0,this.x=i,this.y=s,this.w=t,this.h=e,this.type=n,this.endPos=U(this),this.speed=7,this.angle=Math.atan2(this.endPos.y-this.y,this.endPos.x-this.x),this.remove=!1,this.alpha=1,this.colour="#"+["FF0000","B30000","7D0000","FF8080"][j(0,3)],this.no=1,"dust"==this.type&&(this.colour="#"+["4d1933","EDEDED"][j(0,1)],this.alpha=.1),this.rndCol=a,this.lastDir=o,this.update=function(t,e){if(this.time+=e,t.save(),t.translate(xt.cam.x,xt.cam.y),"circle"==this.type){let e=Math.atan2(this.y-this.endPos.y,this.x-this.endPos.x)+Math.PI+2*(Math.random()-.5);Math.hypot(this.endPos.x-this.x,this.endPos.y-this.y)>=10&&(this.x+=Math.cos(e)*this.speed-6*this.time,this.y+=Math.sin(e)*this.speed-6*this.time),this.alpha-=.01,this.w>1&&(this.w-=.75),t.beginPath(),t.globalAlpha=this.alpha,t.arc(this.x,this.y,this.w,0,6.283185307179586);let i=this.rndCol?P():this.colour;t.fillStyle=i,t.fill(),this.time>.6&&(this.remove=!0)}else"dust"==this.type&&(this.lastDir==It?this.x-=2:this.x+=2,this.y-=j(1,5)/10,t.beginPath(),t.globalAlpha=this.alpha,t.arc(this.x,this.y,this.w,0,6.283185307179586),t.fillStyle=this.colour,t.fill(),this.alpha>.1&&(this.alpha-=.01),this.w+=.1,this.time>.5&&(this.remove=!0));t.globalAlpha=1,t.restore()}}function x(t=0,e=0){this.x=t,this.y=e}var p=[];function v(t,e){for(m=u.createBuffer(1,96e3,48e3),gainNode=u.createGain(),b=m.getChannelData(0),i=96e3;i--;)b[i]=getSound(t,i);s=u.createBufferSource(),s.buffer=m,s.connect(gainNode),gainNode.connect(u.destination),gainNode.gain.value=e,s.start()}function w(e){if(t=((t,e)=>(e-t)/e),e>7e4)return null;t(e,7e4);return Math.sin(.001*e*Math.sin(.009*e)+Math.sin(e/100))}function g(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return(128&Math.pow(t,1.055)?1:-1)*Math.pow(e,2)}function M(t){if(t>5e4)return null;var e=(5e4-t)/5e4;return(200&Math.pow(t,.9)?1:-1)*Math.pow(e,3)}function k(t){var e=1e4;if(t>e)return null;var i=(e-t)/e,s=Math.pow(i,2.1);return Math.pow(t,3)&(t<3333.3333333333335?16:99)?s:-s}function S(t){if(t>2e4)return null;var e=(2e4-t)/2e4;return Math.sin(.003*-t*Math.sin(.09*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function T(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return Math.sin(.01*t*Math.sin(.009*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function E(e){if(e>2e3)return null;t=((t,e)=>(e-t)/e);var i=t(e,2e3);return 33&Math.pow(50*e,.7)?i:-i}function R(e){if(t=((t,e)=>(e-t)/e),e>2e4)return null;var i=t(e,2e4);return e*=.04,Math.sin(.03*-e*Math.sin(.09*e+Math.sin(e/200))+Math.sin(e/100))*i}function A(){var t=!0;this.cam=new x,this.ratio=1,this.tips=!0,this.time=0,this.ratio=Z>800?Z/800:$/600,this.scale=2,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new Q(16,16,0,0,0,C.HERO,this.scale),this.introT=0,this.shake=0,this.shakeTime=0,this.reset=!1,this.wait=2,this.genLevel=function(t){this.levels=[];var e=new q(1,Z,$,this.scale);e.reset(1,this.scaled),this.levels.push(e),this.level=this.levels[0],this.hero.e.curLevel=0,this.hero.e.x=this.level.startPos[0],this.hero.e.y=this.level.startPos[1]},this.genLevel(0),this.level.objs.push(this.hero.e);this.levels[this.hero.e.curLevel].cols;this.update=function(e,i,s=!1){this.time=i,t&&(t=!1,ctx.scale(this.ratio,this.ratio)),this.shake=dt?Math.cos(st):0,this.hero.setCurrentTile(this.scaled),s||(this.level.draw(this.hero,e),this.hero.update(ctx,e),wt.canvas.style.cursor="none"),this.cam.x=X(400-this.hero.e.x-20,this.cam.x,.8),this.cam.y=X(300-this.hero.e.y-80,this.cam.y,.8)}}getSound=function(t,e){var i;switch(t){case Qt:i=w(e);break;case Zt:i=k(e);break;case $t:i=g(e);break;case _t:i=M(e);break;case te:i=S(e);break;case ee:i=T(e);break;case ie:i=E(e);break;case se:i=R(e);break;default:return 1}return i};const C={AIR:0,GRASS:1,HERO:2,BRDE:3,WTR:4,SEA:5,SND:6,TREE:7,RCK:8,CST:9,CNE:10},D={FOLLOW:0,SIMPLE:1};function H(t,e,i,s,h,n,a,o,r,l){this.id=t,this.up=L(o,r,colz,colz),s+=this.up,this.drop=I(o,r,colz,colz),this.e=new J(e,e,i,s,h,n,"",l,0,0),this.up>=0&&n==C.GRASS?(this.e.sx=16,this.e.sy=16):-12==this.up&&n==C.GRASS&&(this.e.sx=32,this.e.sy=16),this.column=o,this.row=r,this.active=!0,n==C.GRASS&&(this.e.y-=4),n==C.SND&&(this.e.y+=2),this.oscillationSpeed=.8,this.oscillationAmount=7,this.initialY=this.e.y,this.e.y=this.e.y+this.drop,this.update=function(t){if(this.e.y=X(this.e.y,this.initialY,.08),this.e.type==C.SEA){let t=.001*Date.now(),e=Math.sin(t*this.oscillationSpeed+this.column)*this.oscillationAmount;this.e.offsetY=0,this.e.y=this.initialY+e}this.e.update(t)},this.isTile=function(){return!0}}function I(t,e,i,s){const h=i/2,n=s/2,a=Math.min(i,s)/3,o=(t-h)*(t-h)+(e-n)*(e-n);return-(500*Math.exp(-o/(2*a*a)))}function L(t,e,i,s){const h=i/2,n=s/2,a=Math.min(i,s)/4,o=Math.min(i,s)/3,r=2*(Math.random()-.5),l=t+r,c=e+r,f=Math.sqrt((l-h)*(l-h)+(c-n)*(c-n));return f<a?-24:f<o?-12:0}function W(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s}function P(){let t="#";for(var e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}function j(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function B(t){return new W(t.x,t.y,t.w,t.h)}function N(t,e,i,s,h,n,a,o){return t<h+a&&t+i>h&&e<n+o&&e+s>n}function O(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function Y(t,e){this.x=t,this.y=e,this.set=function(t,e){this.x=t,this.y=e}}function G(t,e,i,s,h,n,a,o,r,l,c=0){t.save(),t.globalAlpha=r,t.translate(a,o),c>0&&(t.translate(24,24),t.rotate(c*Math.PI/180),t.translate(-24,-24)),t.drawImage(e,i,s,h,n,h/2,n/2,h*l,n*l),t.restore()}function F(t,e,i,s,h,n,a,o,r){t.save(),t.globalAlpha=r,t.translate(e,i),t.fillStyle=o,t.fillRect(s,h,n,a),t.restore()}function K(){}function U(t){var e=j(0,360)*Math.PI/180,i=j(50,180),s=[-1,1][j(0,1)]*i;return{x:t.x+s*Math.cos(e),y:t.y+s*Math.sin(e)}}function X(t,e,i){return(1-i)*t+i*e}function V(t,e){const i=Math.floor(t/2),s=Math.floor(e/2);return{x:16*(i-s)/2,y:16*(i+s)/2}}function q(t,e,i,s){ut=t,this.tiles=[],this.objs=[],this.castle=[],this.active=!1,this.startPos=[0,260],this.cols=colz,this.rotate=!1;let h=0;this.draw=function(t,e,i){this.tiles.forEach(t=>t.update(e,i)),this.objs.sort((t,e)=>t.y-e.y),this.objs.forEach(t=>t.update(e)),this.castle.forEach(t=>t.update(e)),t.e.y>280&&t.e.update(e),this.rotate&&(!function(t){let e=colz;for(let i=0;i<e;i++)for(let s=i+1;s<e;s++){let h=t.level.tiles[i*e+s],n=t.level.tiles[s*e+i];a(h,n)}for(let i=0;i<e;i++)for(let s=0;s<e/2;s++){let h=t.level.tiles[i*e+s],n=t.level.tiles[i*e+(e-s-1)];a(h,n)}}(xt),this.rotate=!1)},this.reset=function(t,e){console.log("RESET"),this.tiles=[],this.dTiles=[],h=0;let i=j(2,5),a=0,l=colz,f=0;for(r=0;r<l;r++)for(c=0;c<this.cols;c++){let t=1;r<4||c<4||c>colz-4||r>colz-4?t=C.SEA:(r<6||c<6||c>colz-6||r>colz-6)&&j(0,100)>50?t=C.SEA:(r<8||c<8||c>colz-8||r>colz-8)&&j(0,100)>20?t=C.SND:j(0,100)>99&&a<i&&(t=C.WTR,a++),xx=16*(c-r),yy=8*(c+r);var u=new H(f,16,xx,yy,0,t,!1,c,r,s);this.tiles.push(u),f++}const y=[];var d,x,p,v,m;this.tiles.forEach((t,e)=>{(function(t){return t==C.WTR})(t.e.type)&&Array.from({length:j(3,8)},(t,e)=>e).forEach(e=>{Array.from({length:j(3,5)},(t,e)=>e).forEach(i=>{let s=(p=t.row+e,v=t.column+i,m=colz,p*m+v);s=s,x=this.tiles.length,s>=0&&s<x&&y.push(s)})})}),y.forEach(t=>{j(0,100)>20&&this.tiles[t].e.type!=C.WTR&&(this.tiles[t].e.type=C.WTR,this.tiles[t].e.setType(),this.tiles[t].initialY+=6)});let w=V(colz-1,colz-1);maxTrees=10,trees=0,maxRocks=5,rocks=0,this.tiles.forEach(t=>{t.e.type==C.GRASS&&j(0,100)>98&&trees<maxTrees?o(t.e.x,t.e.y-t.drop-10-30,w)||(obj=new J(16,23,t.e.x,t.e.y-t.drop-10-30,0,C.TREE,"",s,!1,0),obj.parent=t,this.objs.push(obj),trees++):t.e.type==C.GRASS&&j(0,100)>98&&rocks<maxRocks&&(o(t.e.x,t.e.y-t.drop-10,w)||(obj=new J(16,16,t.e.x,t.e.y-t.drop-10,0,C.ROCK,"",s,!1,0),obj.parent=t,this.objs.push(obj),rocks++))}),n(this.castle,w.x+5,w.y-86,4,0,16,!0,C.CST,!0),n(this.castle,w.x-10,w.y-64,1,0,16),n(this.castle,w.x-26,w.y-56,1,0,16),n(this.castle,w.x-41,w.y-64,4,0,16,!0,C.CST,!0),n(this.castle,w.x+22,w.y-64,1,0,-16,!1),n(this.castle,w.x+38,w.y-56,1,0,-16,!1),n(this.castle,w.x+54,w.y-64,4,0,16,!0,C.CST,!0),n(this.castle,w.x+38,w.y-24,2,0,-16,!1),n(this.castle,w.x+22,w.y-18,2,0,-16,!1),n(this.castle,w.x-26,w.y-8,3,0,-16,!1),n(this.castle,w.x-10,w.y,3,0,-16,!1),n(this.castle,w.x+6,w.y-40,4,0,16,!0,C.CST,!0)};const n=(t,e,i,h,n=0,a=8,o=!0,r=C.CST,l=!1)=>{const c=o?t=>t>=0:t=>t<h,f=o?t=>--t:t=>++t;for(let l=o?h-1:0;c(l);l=f(l))t.push(new J(16,16,e+n*l,i+a*l,0,r,"",s,!1,0));l&&t.push(new J(16,16,e+n,i+a-20,0,C.CNE,"",s,!1,0))};function a(t,e){let i=t.e.type;t.e.type=e.e.type,e.e.type=i,t.e.setType(),e.e.setType()}function o(t,e,i){const s=[-90,i.y-100],h=[90,i.y+20];return t>=s[0]&&t<=h[0]&&e>=s[1]&&e<=h[1]}}function J(t,e,i,h,n,a,o,r,l=!1,c=0){this.scale=r,this.type=a,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWScld=t/-2*r,this.mhHScld=e/-2*r,this.hWidth=t/2,this.hHeight=e/2,this.cenX=i-this.mhWScld,this.cenY=h-this.mhHScld,this.angle=n,this.x=i,this.y=h,this.active=!0,this.colour=o,this.image=yt,this.animated=!1,this.alpha=1,this.currentTile=0,this.colArr=[],this.isSolid=!1,this.isButton=l,this.time=0,this.maxHP=c,this.hp=this.maxHP,this.flip=!1,this.idle=0,this.chk=!1,this.offsetY=0,this.parent=null,this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new W(0,0,0,0),this.sensor=new W(0,0,0,0),this.isButton&&(this.hb.w=2*this.width,this.hb.h=2*this.height)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.scale/2,this.hb.y=this.y+this.scale/2,this.hb.w=this.width*this.scale-this.scale,this.hb.h=this.height*this.scale-this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.update=function(i){if(this.idle+=i,this.updateHitbox(),this.active){if(ctx.save(),ctx.translate(this.x,this.y),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,t=this.width,e=this.height,xt.shakeTime>0&&(xt.shakeTime-=i/1e3,ctx.translate(xt.shake,xt.shake)),ctx.translate(xt.cam.x,xt.cam.y),null==this.image)ctx.fillStyle=this.colour,ctx.fillRect(.5*mhw*s,.5*mhh*s,.5*t*s,.5*e*s);else{if(this.flip?(ctx.scale(-1,1),ctx.translate(-t*s-t,0)):ctx.scale(1,1),f=0,z=0,this.angle>0){let t=24;ctx.translate(t,t),ctx.rotate(this.angle*Math.PI/180),ctx.translate(-t,-t)}ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh+f,t*s,e*s)}ctx.restore()}this.cenX=this.x-this.mhWScld,this.cenY=this.y-this.mhHScld},this.isHero=function(){return this.type==C.HERO},this.isTile=function(){return!1},this.setT=function(t){this.type=t,this.setType()},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.isSolid=!1,this.type){case C.HERO:this.isSolid=!0,this.sx=0,this.sy=0;break;case C.GRASS:this.sx=16;break;case C.BRDE:this.sx=32;break;case C.WTR:case C.SEA:this.sx=48;break;case C.AIR:this.sx=144;break;case C.SND:this.sy=16;break;case C.TREE:this.isSolid=!0,this.sx=80;break;case C.ROCK:this.isSolid=!0,this.sx=64;break;case C.CST:this.isSolid=!0,this.sx=64,this.sy=16;break;case C.CNE:this.sx=48,this.sy=16}},this.setType()}function Q(t,i,s,h,n,a,o){this.e=new J(t,i,s,h,n,a,"",o,!1,100),this.active=!0,this.hp=2,this.particles=[];let r=null,l=null,c=0,f=0,u=(this.e.x,this.e.y,0),y=0,d=0,x=0,p=!1;this.deaths=0,this.done=!1,this.changeLevel=!1,this.moved=!1,this.update=function(t,e){this.time+=e,c+=e,this.moved=!1,this.active&&(St()||Tt()||Et()||Rt()?(u+=e,f=f>3?3:f+=.5):(f=f>0?f-=.5:0,u=0),Et()&&(this.e.y-=this.gMove(0,1),this.moved=!0),Rt()&&(this.e.y+=this.gMove(0,-1),this.moved=!0),St()&&(this.e.x-=this.gMove(-1,0),this.e.flip=!0,this.moved=!0),Tt()&&(this.e.x+=this.gMove(1,0),this.e.flip=!1,this.moved=!0)),(Et()||At()||Dt()||Tt()||St())&&(c=0);for(let i=0;i<=this.particles.length-1;i++)this.particles[i].update(t,e);u>.35&&this.addDust(),d=this.e.x-this.e.mhWScld,x=this.e.y-this.e.mhHScld},this.reset=function(){this.done=!1,this.particles=[],this.hp=2;let t=xt.levels[this.e.curLevel];this.e.x=t.startPos[0],this.e.y=t.startPos[1]},this.kill=function(){this.active&&(this.deaths++,xt.shakeTime=.15,v(ee,1),this.hp--,this.active=!1,y=.5,f=0,this.e.sy=16,0==this.hp&&this.hp++)},this.setCurrentTile=function(t){if(this.moved){l=r;const e=this.e.x/t,i=(this.e.y+1.5*this.e.height)/t*2,s=i-e,h=e+i;heroRow=Math.floor(s),heroCol=Math.floor(h),heroTileIndex=heroCol+xt.levels[this.e.curLevel].cols*heroRow,(r=xt.level.tiles[heroTileIndex])&&l&&r.id!==l.id&&l.up!==r.up&&(this.e.y+=.5*(r.up-l.up))}},this.addDust=function(t=!1){u=0},this.jump=function(){},this.gMove=function(t,i,s=!1,h=!1){this.e.idle=0;var n=f;rec=B(this.e.hb),rec.x+=t*n,rec.y+=i*n,canMove=!0,amount=n;for(var a=n;a>0;a--){canMove=!0;for(var o=0;o<this.e.colArr.length;o++)if(obj=this.e.colArr[o],null!=obj&&null!=obj.entity){if(e=obj.entity,obj.isTile()&&O(e.hb,rec)&&obj.active&&e.isSolid){canMove=!1;break}}else this.e.y>500&&(p=!0);if(canMove)break;amount--,rec.x-=t,rec.y-=i}return amount}}colz=30;let Z=window.innerWidth,$=window.innerHeight,_=!1,tt=0,et=Date.now(),it=Date.now(),st=0,ht=0,nt=new Y(0,0),at=new Y(0,0),ot=!1,rt=!1,lt=!1,ct="990099",ft=!1,ut=1,yt=new Image;yt.src="atlas.png";let dt=!0,xt=new A,pt=!1,vt=!0,mt=!1;function startGame(){wt.start()}y();let wt={canvas:document.createElement("canvas"),start:function(){this.canvas.width=Z,this.canvas.height=$,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),ctx=this.context,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(bt,20),window.addEventListener("keydown",function(t){pt=!0,t.preventDefault(),wt.keys=wt.keys||[],wt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){wt.keys[t.keyCode]="keydown"==t.type,t.keyCode==qt&&(lt=!0),t.keyCode==Nt&&(mt=!mt),t.keyCode==Jt&&(xt.tips=!xt.tips)}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,4*this.canvas.width,4*this.canvas.height)}};function bt(){if(rt&&(st=0,rt=!1,ft=!1,ut=0,pt=!1,_=!1,xt.genLevel(ut)),pt&&(null!=xt.hero&&(xt.hero.e.active=!0),_=!0,null==u&&(u=new AudioContext)),et=it,it=Date.now(),st+=tt=it-et,_){wt.clear(),xt.update(tt,st,!1);let t="15px Verdana";kt(ctx,1,t,"WHITE","[M] Music: "+!mt,650,20),kt(ctx,1,t,"WHITE","[T] Tips: "+xt.tips,650,40),kt(ctx,1,t,"WHITE","[R] Reset Level",650,60),kt(ctx,1,t,"WHITE","Lives: "+xt.hero.hp,10,40),kt(ctx,1,t,"RED","Deaths: "+xt.hero.deaths,10,60),kt(ctx,1,t,"WHITE","Level: "+(xt.hero.e.curLevel+1),10,20),kt(ctx,1,t,"WHITE","X: "+xt.hero.e.x,10,80),kt(ctx,1,t,"WHITE","Y: "+xt.hero.e.y,10,100);xt.hero.e.curLevel;mt&&(h.pause(),vt=!0),vt&&n&&!mt&&(h.play(),h.loop=!0,vt=!1)}else{wt.clear(),ctx=wt.context,xt.update(tt,st,!0),ctx.save(),gt(ctx,.1,"#"+ct,0,0,800,600),kt(ctx,1,"20px Verdana","WHITE","Main Screen",50,40),ctx.restore(),ctx.save()}}function gt(t,e,i,s,h,n,a){t.globalAlpha=e,t.fillStyle=i,t.fillRect(s,h,n,a)}function Mt(t,e,i,s,h,n,a){var o=eval('"\\u'+h+'"');t.globalAlpha=e,t.font=i,t.fillStyle=s,t.fillText(o,n,a)}function kt(t,e,i,s,h,n,a){t.globalAlpha=e,t.font=i,t.fillStyle=s,t.fillText(h,n,a)}function St(){return wt.keys&&(wt.keys[Ht]||wt.keys[jt])}function Tt(){return wt.keys&&(wt.keys[It]||wt.keys[Bt])}function Et(){return wt.keys&&(wt.keys[Lt]||wt.keys[Pt])}function Rt(){return wt.keys&&(wt.keys[Wt]||wt.keys[zt])}function At(){return wt.keys&&wt.keys[Gt]}function Ct(){return wt.keys&&wt.keys[Nt]}function Dt(){return wt.keys&&(wt.keys[Kt]||wt.keys[Ft])}var Ht=37,It=39,Lt=38,Wt=40,Pt=87,jt=65,zt=83,Bt=68,Nt=77,Ot=0,Yt=2,Gt=32,Ft=69,Kt=49,Ut=50,Xt=51,Vt=52,qt=82,Jt=84,Qt=0,Zt=1,$t=2,_t=3,te=4,ee=5,ie=6,se=7;